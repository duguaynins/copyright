<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>nins/cospeaker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial; max-width: 800px; margin: 30px auto; }
textarea { width: 100%; min-height: 120px; padding: 10px; border-radius: 8px; border:1px solid #ddd; resize: vertical; }
button { background:#0066ff;color:white;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;margin:4px; }
button.secondary{ background:#444; }
.row{ display:flex; gap:12px; align-items:center; margin-top:10px; }
#pdfContainer { border:1px solid #ddd; margin-top:10px; width:100%; text-align:center; }
canvas { max-width:100%; border:1px solid #ccc; }

#pdfContainer,
#txt {
  width: 100%;
  box-sizing: border-box;
}
</style>
</head>
<body>
<!--h1>文字 & PDF TTS 播放器</h1-->

<!--div class="row">
  <div><h2>文字檔 (.txt)</h2><input type="file" id="fileInputTxt" accept=".txt">  </div>
  <div><h2>報告檔 (.pdf)</h2><input type="file" id="fileInputPdf" accept=".pdf">  </div>
</div-->
<select id="voiceSelect"></select>

<div class="row" id="fileInputTxtRow">
  <h2>文字檔 (.txt)</h2><input type="file" id="fileInputTxt" accept=".txt">
</div>
<div class="row" id="fileInputPdfRow">
  <h2>報告檔 (.pdf)</h2><input type="file" id="fileInputPdf" accept=".pdf">
</div>

<div class="row">
  <button id="prevAllBtn" class="secondary">上一個</button>
  <button id="nextAllBtn" class="secondary">下一個</button>
  <button id="speakBtn">播放 / 產生</button>
  <button id="stopBtn" class="secondary">停止</button>
</div>


<!--h2>PDF 檔案 (.pdf)</h2>
<input type="file" id="fileInputPdf" accept=".pdf">
<div class="row">
  <button id="prevPdfBtn" class="secondary">上一頁</button>
  <button id="nextPdfBtn" class="secondary">下一頁</button>
</div-->

<div id="pdfContainer">
  <canvas id="pdfCanvas"></canvas>
  <p id="pageInfo"></p>
</div>

<!--h2>文字檔 (.txt)</h2>
<input type="file" id="fileInputTxt" accept=".txt">
<div class="row">
  <button id="prevTxtBtn" class="secondary">上一個</button>
  <button id="nextTxtBtn" class="secondary">下一個</button>
</div-->

<textarea id="txt" placeholder="在此輸入要轉語音的文字..."></textarea>

<script>
/* --- TXT 功能 --- */
const txt = document.getElementById('txt');
const fileInputTxt = document.getElementById('fileInputTxt');
const prevTxtBtn = document.getElementById('prevAllBtn');  ///prevTxtBtn
const nextTxtBtn = document.getElementById('nextAllBtn');  ///nextTxtBtn

let lines = [];
let currentIndex = 0;

// 讀取 TXT
fileInputTxt.addEventListener('change', e=>{
  document.getElementById('fileInputTxtRow').style.display = "none";

  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (event)=>{
    lines = event.target.result.split(/\r?\n/).filter(line=>line.trim()!=='');
    currentIndex = 0;
    txt.value = lines[currentIndex] || '';
  };
  reader.readAsText(file);
});

prevTxtBtn.addEventListener('click', ()=>{
  if(lines.length===0) return;
  currentIndex = (currentIndex -1 + lines.length) % lines.length;
  txt.value = lines[currentIndex];
});

nextTxtBtn.addEventListener('click', ()=>{
  if(lines.length===0) return;
  currentIndex = (currentIndex +1) % lines.length;
  txt.value = lines[currentIndex];
});


</script>


<script>
/* --- PDF 功能 --- */
const fileInputPdf = document.getElementById('fileInputPdf');
const pdfCanvas = document.getElementById('pdfCanvas');
const pageInfo = document.getElementById('pageInfo');
const prevPdfBtn = document.getElementById('prevAllBtn');  ///prevPdfBtn
const nextPdfBtn = document.getElementById('nextAllBtn');  ///nextPdfBtn

let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;

const renderPage = async (num)=>{
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale: 1.5 });
  pdfCanvas.height = viewport.height;
  pdfCanvas.width = viewport.width;
  const renderCtx = {
    canvasContext: pdfCanvas.getContext('2d'),
    viewport
  };
  await page.render(renderCtx).promise;
  pageInfo.textContent = `頁面 ${num} / ${totalPages}`;
};

fileInputPdf.addEventListener('change', e=>{
  document.getElementById('fileInputPdfRow').style.display = "none";

  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async (event)=>{
    const typedarray = new Uint8Array(event.target.result);
    pdfDoc = await pdfjsLib.getDocument({data: typedarray}).promise;
    totalPages = pdfDoc.numPages;
    currentPage = 1;
    renderPage(currentPage);
  };
  reader.readAsArrayBuffer(file);
});

prevPdfBtn.addEventListener('click', ()=>{
  if(!pdfDoc) return;
  if(currentPage > 1){ currentPage--; renderPage(currentPage); }
});

nextPdfBtn.addEventListener('click', ()=>{
  if(!pdfDoc) return;
  if(currentPage < totalPages){ currentPage++; renderPage(currentPage); }
});

</script>


<script>
/* --- TTS 選擇 --- */
const voiceSelect = document.getElementById('voiceSelect');
let voices = [];

function loadVoices() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = '';
  voices.forEach((voice, i) => {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = `${voice.name} (${voice.lang})`;
    voiceSelect.appendChild(option);
  });
}

speechSynthesis.onvoiceschanged = loadVoices;  // 有些瀏覽器語音需要 async 載入
loadVoices();  // 預先載一次


/* --- TTS 播放 --- */
const speakBtn = document.getElementById('speakBtn');
const stopBtn = document.getElementById('stopBtn');
let currentUtter = null;

speakBtn.addEventListener('click', ()=>{
  let text = txt.value.trim();
  if(!text && pdfDoc){
    alert('請先選擇文字或輸入要讀的文字。');
    return;
  }
  if('speechSynthesis' in window){
    if(speechSynthesis.speaking) speechSynthesis.cancel();
    currentUtter = new SpeechSynthesisUtterance(text);

    const selectedVoice = voices[voiceSelect.value];  ///???
    if (selectedVoice) { currentUtter.voice = selectedVoice; }  ///???

    currentUtter.onend = ()=> console.log('播放結束');
    currentUtter.onerror = e=> console.error('播放錯誤', e);
    speechSynthesis.speak(currentUtter);
  } else {
    alert('瀏覽器不支援 Web Speech API');
  }
});

stopBtn.addEventListener('click', ()=>{
  if(speechSynthesis.speaking) speechSynthesis.cancel();
});
</script>
</body>
</html>
