<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title translate="no">nins/xy</title>
  
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* åŸºç¤è¨­ç½®ï¼Œé˜²æ­¢å…¨è¢å¹•æº¢å‡º */
    * { box-sizing: border-box; } 

    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; background: #f8fafc; 
      display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
    }

    .toolbar { 
      background: white; 
      padding: 10px 25px; 
      border-bottom: 1px solid #e2e8f0;
      display: flex; 
      flex-direction: column; /* è®“å…§å®¹æ”¹ç‚ºå‚ç›´æ’åˆ—ï¼Œå–ä»£ <br> */
      align-items: center;
      gap: 12px;
    }

    /* é—œéµï¼šæ”¹ç‚ºå‚ç›´æ’åˆ—ä½ˆå±€ */
    #main-layout { 
      display: flex; 
      flex-direction: column; /* ä¸Šä¸‹æ’åˆ— */
      flex: 1; 
      padding: 15px; 
      gap: 15px; 
      overflow: hidden; 
    }

    .view-content {
      flex: 1; 
      width: 100%;
      height: 100%;
      min-height: 0; /* é—œéµï¼šé˜²æ­¢å…§å®¹æ’ç ´ flex å®¹å™¨ */
    }

    /* å€å¡Šå®¹å™¨æ¨£å¼ */
    #blocklyContainer, .card {
      height: 100%;
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      overflow: hidden;
    }

    #blocklyDiv { height: 100%; width: 100%; }
    .card { padding: 10px; display: flex; flex-direction: column; }
    #chart-container { flex: 1; position: relative; min-height: 0; }
    
    button { 
      padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .btn-primary { background: #4f46e5; color: white; }
    
    .tool-group {
      display: flex;         /* å•Ÿç”¨ Flex ä½ˆå±€ */
      gap: 10px;             /* å…ƒç´ ä¹‹é–“çš„é–“è· */
      width: 100%;
      max-width: 600px;      /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…åœ¨å¤§è¢å¹•é•·å¾—å¤ªå¥‡æ€ª */
    }
    /* é—œéµï¼šè®“ tool-group å…§çš„æ‰€æœ‰ç›´æ¥å­å…ƒç´ å¹³åˆ†ç©ºé–“ */
    .tool-group > * {
      flex: 1;               /* æ¯ä¸€ä»½å­å…ƒç´ æ¯”ä¾‹çš†ç‚º 1 */
      min-width: 0;          /* é˜²æ­¢å…§å®¹æ’ç ´ flex é …ç›® */
    }
  </style>
</head>
<body>

<div class="toolbar">
  <div class="tool-group">
    <input type="number" id="Xinput" placeholder="X" oninput="drawAll(Number(document.getElementById('Xinput').value), Number(document.getElementById('Yinput').value))">
    <button style="color: white; background: orange;" onclick="showView('editor')">ğŸ§©</button>
    <button style="color: white; background: #10b981;" onclick="drawAll();showView('chart');">ğŸš€</button>
    <button style="color: white; background: red;" onclick="showView('chart')">ğŸ“Š</button>
    <input type="number" id="Yinput" placeholder="Y" oninput="drawAll(Number(document.getElementById('Xinput').value), Number(document.getElementById('Yinput').value))">
  </div>
  <div class="tool-group">
    <!--input type="range" id="minRange" min="-1000" max="-10" value="-20" oninput="drawAll()">
    <input type="range" id="maxRange" min="10" max="1000" value="20" oninput="drawAll()"!-->
    
    <input type="range" id="XRange" min="-10000" max="10000" value="0" oninput="drawAll()">
    <input type="range" id="YRange" min="-10000" max="10000" value="0" oninput="drawAll()">
  </div>
  <div class="tool-group">
    <input type="range" id="ZRange" min="0.1" max="10" value="1" step="0.1" oninput="drawAll()">
  </div>


</div>

<div id="main-layout">
  <div id="view-editor" class="view-content">
    <div id="blocklyContainer">
      <div id="blocklyDiv"></div>
    </div>
  </div>

  <div id="view-chart" class="view-content">
    <div class="card">
      <div id="chart-container">
        <canvas id="functionChart"></canvas>
      </div>
    </div>
  </div>
</div>

<xml id="toolbox" style="display:none">
  <category name="All" colour="#777777">
    <block type="start_node"></block>
    <block type="math_single"></block>
    <block type="math_arithmetic"></block>
    <block type="variables_get"><field name="VAR">x</field></block>
    <block type="math_number"></block>
  </category>
  <!--category name="è®Šæ•¸èˆ‡èµ·é»" colour="#4f46e5">
    <block type="start_node"></block>
    <block type="variables_get"><field name="VAR">x</field></block>
  </category>
  <category name="æ•¸å€¼" colour="#10b981">
    <block type="math_number"></block>
  </category>
  <category name="é‹ç®—" colour="#f59e0b">
    <block type="math_arithmetic"></block>
    <block type="math_single"></block>
  </category!-->
</xml>

<script>
  // è¦–åœ–é¡¯ç¤ºé‚è¼¯
  function showView(viewName) {
    const editor = document.getElementById('view-editor');
    const chartView = document.getElementById('view-chart');

    if (viewName === 'editor') {
      editor.style.display = 'block';
      chartView.style.display = 'none';
      setTimeout(() => Blockly.svgResize(workspace), 50);
    } else {
      editor.style.display = 'none';
      chartView.style.display = 'block';
      drawAll();
    }
  }

  // Blockly å®šç¾©
  Blockly.Blocks['start_node'] = {
    init: function() {
      this.appendDummyInput().appendField(new Blockly.FieldTextInput("f"), "NAME").appendField("(x)");
      this.appendValueInput("CONTENT").setCheck("Number").appendField("y = ");
      this.setColour(260);
    }
  };

  const workspace = Blockly.inject('blocklyDiv', {
    toolbox: document.getElementById('toolbox'),
    grid: { spacing: 20, length: 3, colour: '#f1f5f9', snap: true },
    renderer: 'zelos'
  });

  function evaluate(block, x) {
    if (!block) return null;
    const type = block.type;
    if (type === 'variables_get') return x;
    if (type === 'math_number') return Number(block.getFieldValue('NUM'));
    
    if (type === 'math_arithmetic') {
      const a = evaluate(block.getInputTargetBlock('A'), x);
      const b = evaluate(block.getInputTargetBlock('B'), x);
      const op = block.getFieldValue('OP');
      if (a === null || b === null) return null;
      switch(op) {
        case 'ADD': return a + b;
        case 'MINUS': return a - b;
        case 'MULTIPLY': return a * b;
        case 'DIVIDE': return b === 0 ? 0 : a / b;
        case 'POWER': return Math.pow(a, b);
      }
    }
    // ... math_single é‚è¼¯çœç•¥ ...
    // --- é—œéµï¼šæ–°å¢å° math_single çš„æ”¯æ´ ---
    if (type === 'math_single') {
      const arg = evaluate(block.getInputTargetBlock('NUM'), x);
      const op = block.getFieldValue('OP');
      if (arg === null) return null;
      switch (op) {
        case 'ROOT': return Math.sqrt(arg);
        case 'ABS': return Math.abs(arg);
        case 'NEG': return -arg;
        case 'LN': return Math.log(arg);
        case 'LOG10': return Math.log10(arg);
        case 'EXP': return Math.exp(arg);
        case 'POW10': return Math.pow(10, arg);
        case 'SIN': return Math.sin(arg); // é€™è£¡è™•ç† sin(x)
        case 'COS': return Math.cos(arg);
        case 'TAN': return Math.tan(arg);
        default: return arg;
      }
    }
    return null;
  }

  let chart = null;
  function drawAll(Xinput=null, Yinput=null) {
    const startBlocks = workspace.getBlocksByType('start_node');

    const Xbase = Xinput !== null ? Number(Xinput) : Number(document.getElementById('XRange').value);
    const Ybase = Yinput !== null ? Number(Yinput) : Number(document.getElementById('YRange').value);
    const Zbase = Number(document.getElementById('ZRange').value);

    // é—œéµä¿®æ­£ï¼šå¼·åˆ¶è½‰ç‚º Number ä»¥å…è®Šæˆå­—ä¸²æ‹¼æ¥
    const minX = Xbase - 20*Zbase;
    const maxX = Xbase + 20*Zbase;
    const minY = Ybase - 20*Zbase;
    const maxY = Ybase + 20*Zbase;

    if (Xinput===null) {
      document.getElementById('Xinput').value = document.getElementById('XRange').value
      document.getElementById('Yinput').value = document.getElementById('YRange').value
    } else {
      document.getElementById('XRange').value = document.getElementById('Xinput').value
      document.getElementById('YRange').value = document.getElementById('Yinput').value
    }
    
    const xValues = [];
    // å‹•æ…‹è¨ˆç®—æ­¥é•·ä»¥ç¶­æŒæ•ˆèƒ½
    const step = (maxX - minX) / 100; 

    for (let i = minX; i <= maxX; i += step) {
      xValues.push(Number(i.toFixed(2)));
    }

    const datasets = [];
    const colorPalette = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444'];

    startBlocks.forEach((startBlock, index) => {
      const target = startBlock.getInputTargetBlock('CONTENT');
      if (!target) return;
      const funcName = startBlock.getFieldValue('NAME');
      const yValues = xValues.map(x => evaluate(target, x));
      datasets.push({
        label: `${funcName}(x)`,
        data: yValues,
        borderColor: colorPalette[index % colorPalette.length],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.2
      });
    });

    const ctx = document.getElementById('functionChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: xValues, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // è®“æ‹‰å‹• Slider æ™‚æ›´æµæš¢
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: false, min: minY, max: maxY, }
        },
        interaction: {
          mode: 'index',     // æ»‘é¼ é è¿‘ X è»¸æ™‚ï¼Œé¡¯ç¤ºè©² X è»¸ä¸Šã€Œæ‰€æœ‰ã€æ•¸æ“š
          intersect: false,  // ä¸éœ€è¦æ»‘é¼ ç›´æ¥æŒ‡åˆ°é»ä¸Šå°±èƒ½é¡¯ç¤º
        },plugins: {
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0, 0, 0, 0.8)', // æç¤ºæ¡†èƒŒæ™¯è‰²
            padding: 10,
            callbacks: {
              // åœ¨æç¤ºæ¡†æ¨™é¡Œé¡¯ç¤º X å€¼
              title: function(context) {
                return 'x = ' + context[0].label;
              },
              // é¡¯ç¤ºå„å‡½æ•¸çš„ Y å€¼
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2); // é¡¯ç¤ºå…©ä½å°æ•¸
                }
                return label;
              }
            }
          }
        },
      }
    });
  }
function init() {
  const variableX = workspace.getVariable('x') || workspace.createVariable('x');

  // --- å‡½æ•¸ 1: f(x) = x * x ---
  const startF = workspace.newBlock('start_node');
  startF.setFieldValue('f', 'NAME');
  startF.initSvg(); startF.render(); startF.moveBy(20, 20);

  const mul = workspace.newBlock('math_arithmetic');
  mul.setFieldValue('MULTIPLY', 'OP');
  mul.initSvg(); mul.render();

  const x1 = workspace.newBlock('variables_get');
  x1.setFieldValue(variableX.getId(), 'VAR');
  const x2 = workspace.newBlock('variables_get');
  x2.setFieldValue(variableX.getId(), 'VAR');

  x1.initSvg(); x1.render();
  x2.initSvg(); x2.render();

  mul.getInput('A').connection.connect(x1.outputConnection);
  mul.getInput('B').connection.connect(x2.outputConnection);
  startF.getInput('CONTENT').connection.connect(mul.outputConnection);

  // --- å‡½æ•¸ 2: g(x) = sin(x) ---
  const startG = workspace.newBlock('start_node');
  startG.setFieldValue('g', 'NAME');
  startG.initSvg(); startG.render(); startG.moveBy(20, 150); // å¾€ä¸‹ä½ç§»ï¼Œé¿å…é‡ç–Š

  const sinBlock = workspace.newBlock('math_single');
  sinBlock.setFieldValue('SIN', 'OP');
  sinBlock.initSvg(); sinBlock.render();

  const x3 = workspace.newBlock('variables_get');
  x3.setFieldValue(variableX.getId(), 'VAR');
  x3.initSvg(); x3.render();

  sinBlock.getInput('NUM').connection.connect(x3.outputConnection);
  startG.getInput('CONTENT').connection.connect(sinBlock.outputConnection);
  
// --- å‡½æ•¸ 3: h(x) = x * x * x ---
const startH = workspace.newBlock('start_node');
startH.setFieldValue('h', 'NAME');

// 1. å»ºç«‹ä¹˜æ³•èˆ‡è®Šæ•¸ç©æœ¨
const mulH1 = workspace.newBlock('math_arithmetic');
mulH1.setFieldValue('MULTIPLY', 'OP');
const mulH2 = workspace.newBlock('math_arithmetic');
mulH2.setFieldValue('MULTIPLY', 'OP');

const x4 = workspace.newBlock('variables_get');
x4.setFieldValue(variableX.getId(), 'VAR');
const x5 = workspace.newBlock('variables_get');
x5.setFieldValue(variableX.getId(), 'VAR');
const x6 = workspace.newBlock('variables_get');
x6.setFieldValue(variableX.getId(), 'VAR');

// 2. é—œéµï¼šå°æ‰€æœ‰ç©æœ¨åŸ·è¡Œ initSvg (å¦å‰‡é€£ç·šåº§æ¨™æœƒå‡ºéŒ¯)
[startH, mulH1, mulH2, x4, x5, x6].forEach(b => b.initSvg());

// 3. é€²è¡Œçµ„è£ (x * x) * x
mulH1.getInput('A').connection.connect(x4.outputConnection);
mulH1.getInput('B').connection.connect(x5.outputConnection);
mulH2.getInput('A').connection.connect(mulH1.outputConnection);
mulH2.getInput('B').connection.connect(x6.outputConnection);
startH.getInput('CONTENT').connection.connect(mulH2.outputConnection);

// 4. æœ€å¾Œæ¸²æŸ“é ‚å±¤ç©æœ¨ï¼Œå®ƒæœƒéè¿´æ¸²æŸ“æ‰€æœ‰å…§åµŒç©æœ¨
startH.render();

  startH.initSvg(); startH.render();
  startH.moveBy(20, 300); // å†å¾€ä¸‹ç§»å‹•ï¼Œé¿å…é‡ç–Š

  // ç¹ªè£½åˆå§‹åœ–è¡¨
  drawAll();
}
  // åˆå§‹åŒ–
  window.addEventListener('load', () => {
    init();
    ///showView('editor');  // é è¨­é¡¯ç¤ºç·¨è¼¯å™¨
    showView('chart');
    window.addEventListener('resize', () => Blockly.svgResize(workspace));
  });
</script>
</body>
</html>