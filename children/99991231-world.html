
<body>
<script src="https://copyright.nins.cc/children/0001/nins-update.js"></script>
<script src="https://copyright.nins.cc/children/0001/nins-world.js"></script>
<style>
.leaflet-marker-icon {
  transition: all 0.3s linear;
}
</style>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="free-map" style="height: 400px;"></div>
<input id="point-name">
<button onclick="send();" translate="no">ğŸš€</button>
<button onclick="GPS();" translate="no">ğŸ“¶</button>
<button onclick="output();" translate="no">ğŸ’¾</button>
<button onclick="degreen();" translate="no">ğŸŸ¢</button>
<button onclick="dered();" translate="no">ğŸ”´</button>
<button onclick="deall();" translate="no">âšª</button>




<script>
  let USER = null;

  const GREEN = "GPS";
  function degreen() {
    localStorage.removeItem(GREEN);
    console.log("degreen!!!");
  }

  const RED = "Search";
  function dered() {
    localStorage.removeItem(RED);
    console.log("dered!!!");
  }

  function deall() {
    localStorage.clear();
    console.log("deall!!!");
  }
</script>


<script>
  // 3. åˆå§‹åŒ–åœ°åœ–ï¼Œè¨­å®šåº§æ¨™ [ç·¯åº¦, ç¶“åº¦] èˆ‡ ç¸®æ”¾ç­‰ç´š
  var map = L.map('free-map').setView([0.0, 0.0], 1);
  
  var allMarkers = []; // ç”¨ä¾†å­˜æ”¾ marker ç‰©ä»¶çš„é™£åˆ—
  ///var allMarkers = JSON.parse(localStorage.getItem(storage)) || [];

  async function initMap(gp, name) {  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const BufRED = JSON.parse(localStorage.getItem(RED)) || [];
    BufRED.forEach((marker, index) => {
      const gps = marker.gps
      const name = marker.name
      const tag = marker.time
      const time = marker.time
      const data = [{ gps: gps, name: name, tag: RED, time: time }];  ///***

      console.log(index, data);
      useCoordsGenPoint(data);
    })
    
    const BufGREEN = JSON.parse(localStorage.getItem(GREEN)) || [];
    BufGREEN.forEach((marker, index) => {
      const gps = marker.gps
      const name = marker.name
      const tag = marker.time
      const time = marker.time
      const data = [{ gps: gps, name: name, tag: GREEN, time: time }];  ///***

      console.log(index, data);
      useCoordsGenPoint(data);
    })

    allMarkers = [].concat(BufRED).concat(BufGREEN);
  }
  
  async function useCoordsGenPoint(data) {  ///zoom=18
    let zoom = 3;  // è¶Šå°ç‰ˆåœ–è¶Šå¤§
    const { gps, name, tag, time } = data[0];

    ///if (zoom) { map.setView(gps, zoom); }  // ç§»å‹•åœ°åœ–
    ///map.setView(gps, map.getZoom());

    ///map.setView(gps, zoom);
    ///console.log(map.getZoom());  ///1~18

    ///map.panTo(gps);
    ///map.setView(gps, zoom);
    ///map.flyTo(gps, map.getZoom());
    ///map.setView(gps, zoom);
      
    if (tag==="now") {
      zoom = 10;
      L.marker(gps).addTo(map)  // æ¨™è¨˜åœ°é»
        .bindPopup(time)  ///***
        .openPopup();
      
      /*
      L.circle([35.676, 139.763], {
          radius: 500,       // åŠå¾‘ 500 ç±³
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.3
      }).addTo(map);  */
    }
    if (tag===RED) {
      ///zoom = 3;
      L.circleMarker(gps, {
        radius: 8,
        color: 'red',
        fillColor: 'red',
        fillOpacity: 0.8
      }).addTo(map)
        .bindPopup(name)
        .openPopup();
    }
    if (tag===GREEN) {
      ///zoom = 3;
      L.circleMarker(gps, {
        radius: 8,
        color: 'green',
        fillColor: 'green',
        fillOpacity: 0.8
      }).addTo(map)
        .bindPopup(time)  ///***
        .openPopup();
    }

    
    if (zoom===map.getZoom()) {
      map.flyTo(gps, zoom, {
        animate: true,
        duration: 3   // ç§’æ•¸ï¼Œè¶Šå¤§è¶Šå¹³é †
      })
    } else {
      map.setView(gps, zoom);
    }
  }

  // 4. åŠ å…¥ OpenStreetMap åœ–å±¤ (é€™æ˜¯åœ°åœ–å½±åƒçš„ä¾†æº)
  initMap();

  // 5. åŠ å…¥ä¸€å€‹æ¨™è¨˜é» (Marker)
  ///useCoordsGenPoint_vt([25.0330, 121.5654], 'é€™æ˜¯å°åŒ— 101 é™„è¿‘');


</script>


<script>
  async function getNameByGPS(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

    return fetch(url)
      .then(res => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then(data => data.display_name || "æœªçŸ¥åœ°é»")
      .catch(err => {
        console.error("åå‘åœ°ç†ç·¨ç¢¼éŒ¯èª¤:", err);
        return "æœªçŸ¥åœ°é»";
      });
  }

  async function useCoordsGenPointbyName(name) {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`);
    const result = await response.json();

    if (result && result.length > 0) {
      const lat = result[0].lat;
      const lon = result[0].lon;
      console.log(`æ‰¾åˆ°åº§æ¨™ï¼š${lat}, ${lon}`);
      ///return [lat, lon]
      
      // å°‡åœ°åœ–ç§»å‹•åˆ°è©²é»ä¸¦æ’æ——
      let [times, offset] = updateTime();
      let buf = `${times}${offset}`;
      let gps = [lat, lon].map(Number); ///name = `${times}${offset}`;
      const data = [{ gps: gps, name: name, tag: RED, time: buf }];  ///***
      
      useCoordsGenPoint(data);
      ///allMarkers.push({ gps: gps, name: name, tag: RED }); // å­˜å…¥è³‡æ–™
      const oldData = JSON.parse(localStorage.getItem(RED)) || [];
      const newData = oldData.concat( data );
      localStorage.setItem(RED, JSON.stringify(newData));
      console.log(newData);

      ///map.setView([lat, lon], 15);
      ///L.marker([lat, lon]).addTo(map).bindPopup(name).openPopup();
    } else {
      alert("æ‰¾ä¸åˆ°é€™å€‹åœ°é»");
    }
  }  
  
  function output() {
      if (allMarkers.length === 0) {
          alert("ç›®å‰åœ°åœ–ä¸Šæ²’æœ‰é»ä½å¯ä»¥ä¸‹è¼‰ï¼");
          return;
      }

      // 1. å°‡è³‡æ–™è½‰ç‚º JSON å­—ä¸²
      const dataStr = JSON.stringify(allMarkers, null, 2);
      
      // 2. å»ºç«‹ Blob ç‰©ä»¶ (æª”æ¡ˆå…§å®¹)
      const blob = new Blob([dataStr], { type: "application/json" });
      
      // 3. å»ºç«‹ä¸‹è¼‰é€£çµä¸¦æ¨¡æ“¬é»æ“Š
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "markers_data.json"; // æª”æ¡ˆåç¨±
      document.body.appendChild(link);
      link.click();
      
      // 4. æ¸…ç†è¨˜æ†¶é«”
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
  }
  
  async function send() {  
    const name = document.getElementById('point-name').value;
    await useCoordsGenPointbyName(name);
  }

</script>



<script>
  // é€™æ˜¯ç¯„ä¾‹æ¸¬è©¦
  ///useCoordsGenPoint_vt([25.0330, 121.5654], 'é€™æ˜¯å°åŒ— 101 é™„è¿‘');
  ///useCoordsGenPointbyName_vt('æ—¥æœ¬æ±äº¬');
</script>
<script>
  function path() {
    // ç›£è½æ–¹å‘
    window.addEventListener('deviceorientationabsolute', function(e) {
      // e.alpha æ˜¯æ‰‹æ©Ÿç¹è‘—å‚ç›´è»¸æ—‹è½‰çš„è§’åº¦ (0-360)
      var heading = e.alpha; 
      
      if (heading !== null) {
        // æ—‹è½‰åœ°åœ–å®¹å™¨ (éœ€è¦ä¸€äº› CSS æŠ€å·§è™•ç†é‚Šç·£ç©ºç™½)
        document.getElementById('free-map').style.transform = `rotate(${-heading}deg)`;
      }
    }, true);
  }

  // ç«‹åˆ»è«‹æ±‚ GPS
  function keep() {
    map.locate({
      watch: true,       // æŒçºŒç›£æ¸¬ä½ç½®è®ŠåŒ–
      setView: true,
      enableHighAccuracy: true
    });
    map.on('locationfound', function(e) {
        alert("å®šä½æŒçºŒï¼š" + e.latlng);
        USER.setLatLng(e.latlng);
        map.panTo(e.latlng);
    });
    map.on('locationerror', function(e) {
        alert("å®šä½å¤±æ•—ï¼š" + e.message);
    });
  }

  function GPS() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
              async function(position) {
                  // æˆåŠŸå–å¾— GPS
                  const lat = position.coords.latitude;
                  const lon = position.coords.longitude;
                  
                  // æ™‚é–“è»¸
                  let [times, offset] = updateTime();
                  let gps = [lat, lon].map(Number);
                  let buf = `${times}${offset}`;
                  let name = "ä½¿ç”¨è€…ä½ç½®"; 
                  name = await getNameByGPS(lat, lon);
                  const test = [{ gps: gps, name: name, tag: "now", time: buf }];  ///***

                  // å°‡åœ°åœ–ç§»åˆ°ä½¿ç”¨è€…ä½ç½®
                  useCoordsGenPoint(test);
                  USER = L.marker(gps).addTo(map).bindPopup(buf).openPopup(); ///keep();
                  ///return [gps, name]

                  // å­˜å…¥ allMarkers
                  const data = [{ gps: gps, name: name, tag: GREEN, time: buf }];  ///***
                  const oldData = JSON.parse(localStorage.getItem(GREEN)) || [];
                  const newData = oldData.concat( data );
                  localStorage.setItem(GREEN, JSON.stringify(newData));
                  console.log(newData);
              },
              function(error) {
                  // ä½¿ç”¨è€…æ‹’çµ•æˆ–å…¶ä»–éŒ¯èª¤
                  console.error("ç„¡æ³•å–å¾— GPSï¼š", error.message);
              }
          );
      } else {
          console.error("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½");
      }
  }

</script>
</body>
