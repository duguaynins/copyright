
<body>
<script src="https://copyright.nins.cc/children/0001/nins-update.js"></script>
<script src="https://copyright.nins.cc/children/0001/nins-world.js"></script>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="free-map" style="height: 400px;"></div>
<input id="point-name">
<button onclick="send();" translate="no">ğŸš€</button>
<button onclick="output();" translate="no">ğŸ’¾</button>




<script>
  // 3. åˆå§‹åŒ–åœ°åœ–ï¼Œè¨­å®šåº§æ¨™ [ç·¯åº¦, ç¶“åº¦] èˆ‡ ç¸®æ”¾ç­‰ç´š
  var map = L.map('free-map').setView([0.0, 0.0], 1);
  var allMarkers = []; // ç”¨ä¾†å­˜æ”¾ marker ç‰©ä»¶çš„é™£åˆ—

  async function initMap(gp, name) {  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
  }
  
  async function useCoordsGenPoint(gps, name) {  
    const zoom = 1;  // è¶Šå°ç‰ˆåœ–è¶Šå¤§
    ///map.setView(gps, zoom);  // ç§»å‹•åœ°åœ–
    L.marker(gps).addTo(map)  // æ¨™è¨˜åœ°é»
      .bindPopup(name)
      .openPopup();
  }

  // 4. åŠ å…¥ OpenStreetMap åœ–å±¤ (é€™æ˜¯åœ°åœ–å½±åƒçš„ä¾†æº)
  initMap();

  // 5. åŠ å…¥ä¸€å€‹æ¨™è¨˜é» (Marker)
  ///useCoordsGenPoint([25.0330, 121.5654], 'é€™æ˜¯å°åŒ— 101 é™„è¿‘');


</script>


<script>

  async function useCoordsGenPointbyName(name) {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`);
    const data = await response.json();

    if (data && data.length > 0) {
      const lat = data[0].lat;
      const lon = data[0].lon;
      console.log(`æ‰¾åˆ°åº§æ¨™ï¼š${lat}, ${lon}`);
      ///return [lat, lon]
      
      // å°‡åœ°åœ–ç§»å‹•åˆ°è©²é»ä¸¦æ’æ——
      let [times, offset] = updateTime();
      let gps = [lat, lon]; ///name = `${times}${offset}`;
      
      useCoordsGenPoint(gps, name);
      allMarkers.push({ gps: [lat, lon], name: name }); // å­˜å…¥è³‡æ–™
      ///localStorage.setItem('myMapPoints', JSON.stringify(allMarkers));

      ///map.setView([lat, lon], 15);
      ///L.marker([lat, lon]).addTo(map).bindPopup(name).openPopup();
    } else {
      alert("æ‰¾ä¸åˆ°é€™å€‹åœ°é»");
    }
  }  
  
  function output() {
      if (allMarkers.length === 0) {
          alert("ç›®å‰åœ°åœ–ä¸Šæ²’æœ‰é»ä½å¯ä»¥ä¸‹è¼‰ï¼");
          return;
      }

      // 1. å°‡è³‡æ–™è½‰ç‚º JSON å­—ä¸²
      const dataStr = JSON.stringify(allMarkers, null, 2);
      
      // 2. å»ºç«‹ Blob ç‰©ä»¶ (æª”æ¡ˆå…§å®¹)
      const blob = new Blob([dataStr], { type: "application/json" });
      
      // 3. å»ºç«‹ä¸‹è¼‰é€£çµä¸¦æ¨¡æ“¬é»æ“Š
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "markers_data.json"; // æª”æ¡ˆåç¨±
      document.body.appendChild(link);
      link.click();
      
      // 4. æ¸…ç†è¨˜æ†¶é«”
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
  }
  
  async function send() {  
    const zoom = 1;  // è¶Šå°ç‰ˆåœ–è¶Šå¤§
    const name = document.getElementById('point-name').value;
    useCoordsGenPointbyName(name);
  }

</script>



<script>
  useCoordsGenPoint([25.0330, 121.5654], 'é€™æ˜¯å°åŒ— 101 é™„è¿‘');
  useCoordsGenPointbyName('æ—¥æœ¬æ±äº¬');


</script>

</body>
