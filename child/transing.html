<!DOCTYPE html>
<html lang="en">
<head translate="yes">
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" sizes="48x48" href="data:image/x-icon;base64,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">
  <!--link rel="icon" type="image/x-icon" sizes="48x48" href="https://duguaynins-allninsone.hf.space/favicon.ico"-->
  <!--link rel="icon" type="image/png" sizes="48x48" href="/favicon.png"-->
  <!--link rel="shortcut icon" href="/favicon.ico"-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title translate="no">nins/transing</title>
  <!--title translate="no">これが自由だ</title-->
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <!--link rel="stylesheet" href="style.css"-->
  <!--link rel="stylesheet" href="transing.css"-->
  <style>
    iframe.VIpgJd-ZVi9od-ORHb-OEVmcd {
      /*display: none !important;*/
    }
    #skiptranslate {
      /*display: none;*/
    }
    input, textarea, button, select {
      /*font-size: inherit; /* 主動繼承 body 字體大小 */
      font-size: 18px;
    }
    html, body { font-size: 14px; }
    html, body {
      background-color: #000000;
      margin: 0;
      padding: 0;
      height: 80vh;
      ///font-family: sans-serif;
      ///display: flex;
      ///flex-direction: column;
      
      display: flex;
      flex-direction: column;
      
    }
    #chatbox {
      flex: 1; /* 填滿剩餘空間 */
      margin: 0;
      padding: 0;
      border: 1px solid #ccc;
      overflow: auto;
      ///height: auto;
      ///width: 100%;
      display: flex;
      flex-direction: column-reverse; /* 反轉內容排列 */
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box; /* 推薦加上，避免寬高計算誤差 */
    }
        
    p, summary, details {
      /* text-indent: 0; */
    }
    
    #Container {
      border: 2px solid #ffffff;  黑色邊框、寬度 2px 
      /*border-radius: 8px;      圓角（可選） */
      background-color: #ffffff; /* 白底讓 QR 更清楚（建議） */
      /*padding: 4px;            邊框內留白（可選） */
      /*width: 200px;            固定寬度（可選） */
      /*height: auto;*/
    }
    
    
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.6); /* 半透明背景 */
    }
    dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1rem;
      border: none;
      border-radius: 8px;
      background-color: black;
      color: white;
    }
  </style>
  <style>
    button {
      width: 100%;
      /*padding: 12px;*/
      /*font-size: 16px;*/
      border: none;
      /*border-radius: 10px;*/
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.3s ease;
      background-color: white;  //#777777;  ///#FF3B00;  ///#007BFF;
      color: black;
    }
  
    button:hover {
      background-color: #cdcdcd;  ///#0056b3;
      color: black;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background-color: #cdcdcd;    ///FF3B00;
      color: black;///gray;
    }
  
    button:active {
      background-color: #ffffff;  ///#004080;
      color: gray;
      background-color: #222222;  ///#004080;
      color: white;///gray;
    }
    
    input:hover {
      background-color: #cdcdcd;    ///FF3B00;
      color: black;///gray;
    }
    input:active {
      background-color: #222222;  ///#004080;
      color: white;///gray;
    }
    input:focus {
      outline: none;              /* 移除預設藍色邊框 */
      /* border: 2px solid #4CAF50;  改為綠色邊框 */
      /* box-shadow: 0 0 5px #4CAF50; */
      border: 2px solid red;       /* 或使用 #f44336 */
      box-shadow: 0 0 5px red;
    }
</style>
<style>
    .skiptranslate {
      display: none !important;   /* 避免 display:none 影響內容顯示 */
      position: static !important;   /* 防止位置異常 */
      width: 0px !important;
      height: 0px !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background: none !important;
      font-size: inherit !important;
    }
    iframe {
      display: none !important;
    }
    
    /* 動畫定義：呼吸一次 */
    @keyframes breatheOnce {
      0%   { color: #cdcdcd; }
      50%  { color: black; }  /*red*/
      100% { color: #cdcdcd; }
    }

    .breathe {
      animation: breatheOnce 1s ease-in-out;  /*2s*/
    }
    
    @keyframes blinkBorder {
        0%, 100% { border-color: #FF3B00; }
        50%      { border-color: transparent; }
    }
    
    @keyframes hardBlink {
      0%, 100% { border-color: red; }
      50%      { border-color: transparent; }
    }
    
    .main {
        border: 2px solid red;
        padding: 8px;
        /**animation: blinkBorder 1s infinite;  //===*/
        /* 呼吸式動畫：平滑過渡 */
        /**animation: blinkBorder 1s ease-in-out infinite;  //===*/
        /* 閃爍式動畫：瞬間切換 */
        animation: hardBlink 1.0s steps(1, start) infinite;
    }
</style>

  <style>
    @keyframes fadeGradient {
      from {
        background: linear-gradient(white, white);
      }
      to {
        background: linear-gradient(white, transparent);
      }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
    <div id="google_translate_element" style="display:none;"></div>
  
    
    <button disabled="" id="disabled" style="
      position: fixed;
      bottom: 0;
      top: 0; /* 距離頂部 0 */
      left: 0; /* 距離左側 0 */
      right: 0; /* 距離右側 0 */
      width: 100%;
      height: 100%;
      border: none;
      padding: 0;
      margin: 0;
      /*opacity: 0;  /*不透明度*/
      /*background: transparent;  /*不透明度？*/
      cursor: default;
      z-index: 99999;  /* 確保在最高層 */
      /*background: linear-gradient(white, transparent);*/
      background: white;
      animation: fadeOut 3s forwards;
      pointer-events: none;  /* 動畫期間不阻擋互動（可選）*/
    "></button>
      

  <div style="
    position: fixed;
    bottom: 0;
    top: 0; /* 距離頂部 0 */
    left: 0; /* 距離左側 0 */
    right: 0; /* 距離右側 0 */
    width: 100%;
    background: #777777;
    background: #FF3B00;
    background: white;
    color: white;
    text-align: center;
    /*padding: 10px;*/
    box-sizing: border-box;
    word-break: break-word;
    z-index: 10000;
    
    display: flex;
    flex-direction: column;
  ">
        <div style="background: #FFFFFF; color: black;" translate="no">
        <div style="margin: 10px;" onclick="">
        TRNASING
        </div></div>
        <div style="display: flex; flex-direction: row; border: 1px solid #cdcdcd;" translate="no">
        <button onclick="document.getElementById('DialogShare').showModal()">🔗</button>
        <button onclick="document.getElementById('DialogTool').showModal()">🧰</button>
        <button onclick="downloadChat()">💾</button>
        <button onclick="DUGUAYNINS()" >👻</button>
        </div>
        
        <div id="chatbox" style="border:1px solid #ccc; overflow:auto; width:100%; text-align:left; flex:1;">init</div>
        <input class="main" id="InputRoom" type="text" name="noMemory" autocomplete="off" placeholder="input connection number..." style="width:100%; text-align: center;"/>
        <input class="main" id="InputMsg"  type="text" name="noMemory" autocomplete="off" placeholder="input message text..." style="width:100%; text-align: center;"/>
        <button id="ButtonRoom" onclick="sendSocket()" style="width:100%;" class="button" >📶Send connection</button>
        <button id="ButtonMsg" onclick="sendMessage()" style="width:100%;" class="button" >🚀Send Message</button>
        <!--strong></strong-->
        <div style="background: #FF3B00; color: white;" translate="yes">
        <div style="margin: 10px;" onclick="">
        By using any of the services, it means you have agreed to any content and all content!
        </div></div>
  </div>

  
  
  <dialog style="background-color: #000000;" id="DialogShare">
  
      <!--button onclick="document.getElementById('DialogShare').close()" class="text-red-600 mt-3">❌</button-->
      <!--br><br-->
      <span style="width:100%;">You can set the resolution for the 2D barcode.</span><br>
      <input type="range" id="barcodeSlider" min="100" max="500" value="300" style="width:100%;" /><br>
      <a style="width:100%; display:none;" id="linkText" rel="noopener noreferrer" href=""></a>
      <img style="width:100%;" id="linkCode" onclick="openLink()" alt='QR Code'><br>
      <!--img src="javascript:void(0)"-->
      
      <span style="display:none;">
      <span style="width:100%;">You can set the abilities for the ghost.</span><br>
      <input type="range" id="InputSpeed" min="1.0" max="100.0" step="0.1" value="1" style="width:100%;" /><br>
      <span style="width:100%;">You can set the speed for the audio playback.</span><br>
      <input type="range" id="InputRate" min="0.1" max="10.0" step="0.1" value="1" style="width:100%;" /><br></span>
  </dialog>
  
  <dialog style="background-color: #000000;" id="DialogTool">
  
      <!--button onclick="document.getElementById('DialogTool').close()" class="text-red-600 mt-3">❌</button-->
      <!--br><br-->
      <span style="width:100%;">You can set the display text size.</span>
      <input type="range" id="fontSlider" min="10" max="44" value="16" style="width:100%;" /><br>
      <div style="width:100%;" translate="no">
      
          <label id="ButtonTool" translate="no" >📺（<input style="display:none;" type="button" value="📺" /></label>
          <span translate="no">
          <span id="width" style="width:100%;" translate="no"></span><span translate="no">x</span>
          <span id="height" style="width:100%;" translate="no"></span>
          ）</span><br>
          
          <!--span style="width:100%;" id="copyright">© 2024 NINS. 👻（👻，👻）🏠</span><br-->
          <span id="stateConnection">💬（Connection）</span><br>
          <span id="stateTTS">👄（TTS＃0）</span><br>
          <!--label id="ButtonHear" >👂<input style="display:none;" type="button" value="👂" /></label-->
          <!--label id="ButtonMike" >🎙️（mike）<input style="display:none;" type="button" value="🎙️" /></label-->
          
          <a id="LinkMail" rel="noopener noreferrer" href="mailto:duguaynins@gmail.com">💌</a><span>（duguaynins@gmail.com）</span><br>
          <!--a id="LinkNins" rel="noopener noreferrer" href="https://all.nins.one">🌐</a><span>（all.nins.one）</span><br-->
          <a id="LinkNins" rel="noopener noreferrer" href="https://nins.jpgt.one">🌐</a><span>（nins.jpgt.one）</span><br>
          
          <!--a id="LinkTrans" href="https://translate.google.com/?sl=auto&tl=en&op=translate&text=">💬🔄📱📢</a><span></span-->
          <!--button id="ButtonMike">🎙️</button-->
          <div translate="no">
              
              <label for="Selectslang">🔣（sl-in: </label>
              <select id="Selectslang">
                <!--option value="auto">auto*</option-->
                <option value="en-US">English</option>
                <option value="ja-JP">日本語</option>
                <option value="ko-KR">한국의</option>
                <option value="zh-TW">繁體中文</option>
              </select>）<br>
              <label for="Selectilang">🤖（il-out: </label>
              <select id="Selectilang">
                <!--option value="auto">auto*</option-->
                <option value="en-US">English</option>
                <option value="ja-JP">日本語</option>
                <option value="ko-KR">한국의</option>
                <option value="zh-TW">繁體中文</option>
              </select>）<br>
              <label for="Selecttlang">🔄（tl-out: </label>
              <select id="Selecttlang">
                <option value="auto">auto*</option>
                <!--option value="auto">auto</option-->
              </select>）<br>
          </div>
          
          
          
          <label id="ButtonDL" >📷（camera）<input style="display:none;" type="button" value="📷" onclick="DUGUAYNINS()" /></label><br>
          <label id="ButtonLK" >🔗（link）<input style="display:none;" type="button" value="🔗" onclick="document.getElementById('DialogShare').showModal()"  /></label><br>
          <!--label for="InputFile">📦（file）<input type="button" id="InputFile" value="📦" style="display: none;" onclick="" /></label-->
          <label id="ButtonCM" >💾（save）<input style="display:none;" type="button" value="💾" onclick="downloadChat()" /></label><br>
          <p id="ButtonMike" >🎙️（mike）<input style="display:none;" type="button" value="🎙️" /></p>
          
          <span style="width:100%; color:red;" translate="no" id="copyright" >👻（channels, users）</span><br>
      </div>
  </dialog>
  
  
  
  
  
  
  <!--strong><span style="color: #ffffff;">By using any of the services, it means you have read and agreed to all! ***</span></strong-->
  
  <!--/div-->


    
  <script>
  //////document.getElementById("InputRoom").focus();
  document.querySelectorAll("dialog").forEach(dialog => {
      dialog.addEventListener("click", function (event) {
        const rect = this.getBoundingClientRect();
        const isInDialog =
          event.clientX >= rect.left &&
          event.clientX <= rect.right &&
          event.clientY >= rect.top &&
          event.clientY <= rect.bottom;
    
        if (!isInDialog) {
          this.close();
        }
      });
  });
  </script>
  <script>
  /*
  function openLink(event, el) {
    event.preventDefault(); // 阻止原本的跳轉  // 將先執行 onclick，再依據 href 跳轉
    const href = el.getAttribute("href");
    window.open(href, "_blank", "noopener,noreferrer");
  }
  */
  
  function openLink(event, el) {
    ///event.preventDefault(); // 阻止原本的跳轉  // 將先執行 onclick，再依據 href 跳轉
    const href = document.getElementById("linkText").getAttribute("href");
    window.open(href, "_blank", "noopener,noreferrer");
  }
  </script>
  <script>
    ///document.getElementById('chatbox').style.backgroundColor = '#777777';  ///background-color: #777777;
    
    // 生成隨機字元個數*****
    function randomAlphaString(length) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars[Math.floor(Math.random() * chars.length)];
      }
      return result;
    }
    
    
    // 初始化全域變數*****
    // 聊天****
    // 連線****
    // 翻譯****
    const params = new URLSearchParams(window.location.search);
    
    const uuid_user = randomAlphaString(64);  // 生成64字元
    let ably; // 連線介面
    let channel = null;  // 根據房間連線
    
    // 🔑  ///prompt("（🔑: ***）")
    let apikey_user = "";
    const apikey_nins = ("ijFBLQ.6d_0Tg:5ueQrEJ1sjpW1MN9kDlLOzyPoYyYAzufOmGYxMLEV2s");  // NINS ABLY_ APIKEY
    const token_nins = ("hf_"+"mGuvBfOSKABphqccTuytpyrMTQexewVRpm");  // NINS HF_ APIKEY
    
    const rlang = "en-US";  //relang or resultlang
    const tlang = navigator.language || navigator.userLanguage || "en-US";  // 閱讀母語
    let ilang = tlang;  // 學習語言 OR 中間語言  // params.get("il")
    let slang = tlang;
    
    let speed = 1.2;
  </script>
  
  
  
  
  
  <script>
    // 監聽輸入
    ///window.addEventListener("keydown", updateWindowSize);  // 按鈕持續監聽
  
    /*
    // 監聽點擊
    document.getElementById("ButtonHear").addEventListener("click", () => {
      const button = document.getElementById("ButtonHear");
      if (button.textContent === "👂") { button.textContent = "👂刪減中"; }
      if (button.textContent === "👂追加中") {
        button.textContent = "👂刪減中";
        document.querySelectorAll(".msgtLangm").forEach(el => { el.style.display =  'none'; });
      } else {
        button.textContent = "👂追加中";
        document.querySelectorAll(".msgtLangm").forEach(el => { el.style.display =  ''; });
      }
    });
    */
    
    // 輸入框被焦點時
    document.getElementById("InputRoom").addEventListener('focus', function() {
        // 選取所有 <details> 元素
        const allDetails = document.querySelectorAll('details');
        // 迭代每個 <details> 元素，並移除其 'open' 屬性
        allDetails.forEach(detail => { detail.removeAttribute('open'); });
        ///document.getElementById('InputRoom').focus();
        console.log("InputRoom focus:", 0);
    });
    document.getElementById("InputMsg").addEventListener('focus', function() {
        // 選取所有 <details> 元素
        const allDetails = document.querySelectorAll('details');
        // 迭代每個 <details> 元素，並移除其 'open' 屬性
        allDetails.forEach(detail => { detail.removeAttribute('open'); });
        ///document.getElementById('InputMsg').focus();
        console.log("InputMsg focus:", 0);
    });
    
    // 輸入框被輸入時
    document.getElementById("InputRoom").addEventListener("keydown", function(e) {
        // 選取所有 <details> 元素
        const allDetails = document.querySelectorAll('details');
        // 迭代每個 <details> 元素，並移除其 'open' 屬性
        allDetails.forEach(detail => { detail.removeAttribute('open'); });
        document.getElementById('InputRoom').focus();
        
        if (e.key === "Enter") {
          e.preventDefault();  // 阻止 Enter 鍵的預設行為（即防止跳轉到下一個輸入框）
          ///alert("Enter：" + this.value);
          ///document.getElementById("ButtonRoom").click();
          sendSocket();
        }
        console.log("InputRoom keydown:", 0);
    });
    document.getElementById("InputMsg").addEventListener("keydown", function(e) {
        // 選取所有 <details> 元素
        const allDetails = document.querySelectorAll('details');
        // 迭代每個 <details> 元素，並移除其 'open' 屬性
        allDetails.forEach(detail => { detail.removeAttribute('open'); });
        document.getElementById('InputMsg').focus();
      
        if (e.key === "Enter") {
          e.preventDefault();  // 阻止 Enter 鍵的預設行為（即防止跳轉到下一個輸入框）
          ///alert("Enter：" + this.value);
          ///document.getElementById("ButtonMsg").click();
          sendMessage();
        }
        console.log("InputMsg keydown:", 0);
    });
  </script>
  <script>
    /*
    // 字體***大小手動****
    document.querySelectorAll("input").forEach(el => {
      ///el.style.fontSize = `${size}px`;
    });
    document.querySelectorAll("span").forEach(el => {
      ///el.style.fontSize = `${size}px`;
    });
    // AND
    // 字體***根據視窗大小自動****
    function updateWindowSize() {
        ///document.getElementById("fontSlider").value = window.innerWidth / 66;  //44
        document.getElementById("width").textContent = window.innerWidth;
        document.getElementById("height").textContent = window.innerHeight;
        // 特殊套用**
        const size = document.getElementById("fontSlider").value;
        document.body.style.fontSize = `${size}px`;
        const resize = parseInt(size) + 6;
        document.getElementById("InputRoom").style.fontSize = `${resize}px`;
        document.getElementById("ButtonRoom").style.fontSize = `${resize}px`;
        document.getElementById("InputMsg").style.fontSize = `${resize}px`;
        document.getElementById("ButtonMsg").style.fontSize = `${resize}px`;
        ///document.getElementById("Container").style.padding = (window.innerWidth / 66) + "px";  //QR
        ///document.getElementById("NINS").style.padding = (window.innerWidth / 66) + "px";  //QR
        ///document.getElementById("NINS").style.width = (window.innerHeight / 2) + "px";  //QR
    }*/
    function updateWindowSize() {}
    ///window.addEventListener('resize', () => {});
    window.addEventListener("resize", updateWindowSize);  // 視窗持續監聽
    ///window.addEventListener("keydown", updateWindowSize);  // 按鈕持續監聽
    ///window.addEventListener("scroll", updateWindowSize);  // 滾動持續監聽
    document.addEventListener('DOMContentLoaded', () => {document.getElementById("fontSlider").value = window.innerWidth / 66;});  // 載入監聽
    document.addEventListener('DOMContentLoaded', updateWindowSize);  // 載入監聽
    // AND
    // 字體***根據拉條大小自動****
    document.getElementById("fontSlider").addEventListener('input', updateWindowSize);
    
    
    
    
    function updateQR(token="") {  ///() => {   ///function () {
        console.log('更新條碼:', token);
        // 格式化套用**
        const size = document.getElementById('barcodeSlider').value;
        const input = document.getElementById('InputRoom').value.split('&&')[0];  // OR this.value;
        console.log('更新條碼大小:', size);
        console.log('更新條碼內容:', input);
        
        const secret = "nins";
        let baseUrl = null;
        baseUrl = window.location.origin + window.location.pathname + "?channel=" + encodeURIComponent(input); /// + "&idle=" + params.get("idle");
        if (token) {baseUrl += "&token="+token + "&idle="+secret}
        
        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size="+size+"x"+size+"&data=" + encodeURIComponent(baseUrl);
        ///const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + baseUrl
      
        document.getElementById("linkText").href = baseUrl;  //???
        document.getElementById("linkCode").src = qrUrl;
        ///document.getElementById("linkText").textContent = baseUrl;
        
        ///const resize = parseInt(size) / 75;
        ///document.getElementById("linkCode").style.padding = resize + "px";
        // 房間號碼**
        ///document.getElementById("copyright").innerHTML = "👻（" + input + "，?）";
    
    }
    
    // 不會再有 [object Event] 被當作參數傳入的錯誤。  ///!!!
    // 條碼***根據拉條變化生成+大小****
    ///document.getElementById('barcodeSlider').addEventListener('input', updateQR);
    document.getElementById('barcodeSlider').addEventListener('input', () => { updateQR(); });
    // AND
    // 條碼***根據內容變化生成****
    ///document.getElementById('InputRoom').addEventListener('input', updateQR);
    document.getElementById('InputRoom').addEventListener('input', () => { updateQR(); });
    // AND
    // 條碼***初始化****
    ///document.addEventListener('DOMContentLoaded', updateQR);
    document.addEventListener('DOMContentLoaded', () => { updateQR(); });
  </script>
  
  
  
  <script>
  
    let voices = null;
    // 第一次初始化語音****
    document.addEventListener('DOMContentLoaded', function () {
        voices = window.speechSynthesis.getVoices();
        ///voices = speechSynthesis.getVoices();
        console.log("Voices loaded:", voices.length);
        console.log("Voices loaded:", voices);
        
        if (voices.length > 0) {
            ///alert("GET TTS VOICE＃: " + voices.length);
            document.getElementById("stateTTS").textContent = "👄（TTS＃" + voices.length + "）";
        } else {
            ///document.getElementById("stateTTS").textContent = "👄（TTS＃" + 0 + "）";
        }
    });
    
    
    // 監聽的初始化語音****
    ///window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.addEventListener('voiceschanged', () => {
        voices = window.speechSynthesis.getVoices();
        ///voices = speechSynthesis.getVoices();
        console.log("Voices loaded:", voices.length);
        console.log("Voices loaded:", voices);
        
        voices.forEach((voice, index) => {
          console.log(
            `${index + 1}. 名稱: ${voice.name}, 語言: ${voice.lang}, 是否預設: ${voice.default}`
          );
        });
      
        if (voices.length > 0) {
            ///alert("GET TTS VOICE＝: " + voices.length);
            document.getElementById("stateTTS").textContent = "👄（TTS＝" + voices.length + "）";
        } else {
            ///document.getElementById("stateTTS").textContent = "👄（TTS＃" + 0 + "）";
        }
        
    });
  </script>
  
  <script>
    
    async function semantic(params) {
      console.log('翻譯比對:', params);
      
      let score = null;
      const url = "https://duguaynins-semanticdistance.hf.space/sim";
      const { smsg, rmsg } = params;
      ///if (smsg==rmsg) return "1.000";
      if (smsg==rmsg) return "***";
      
      
      try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token_nins}`, 'Content-Type': 'application/json', },
            body: JSON.stringify({ 
              text1: smsg,
              text2: rmsg,
            })  // ✅ 正確傳參位置  //???target >>> ilang
        });
    
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
    
        const data = await response.json();
        console.log('翻譯結果:', data.similarity);
        ///return data.similarity;
        score = data.similarity;
        
      } catch (error) {
        console.error('請求失敗:', error);
      }
      
      ///return "🎯" + score.toFixed(1);
      return score;
    }
    async function translate(params) {
      // 假設你要傳遞的參數放在 URL query string 裡
      // params 是物件，例如 { text: '你好', target: 'en' }
      
      ///const queryString = new URLSearchParams(params).toString();
      console.log('翻譯原始:', params);
      
      ///const url = `https://duguaynins-apininsown.hf.space/translate?${queryString}`;
      const url = "https://duguaynins-apininsown.hf.space/translate";
      const { text, source = 'auto', target } = params;
      if (source==target) return text;  // 可慮優化效能，但也許需要。  // 還需要顯示英文與語音
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token_nins}`, 'Content-Type': 'application/json', },
          body: JSON.stringify({ text, source, target })  // ✅ 正確傳參位置  //???target >>> ilang
        });
    
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
    
        const data = await response.json();
        console.log('翻譯結果:', data.translated_text);
        return data.translated_text;
        
      } catch (error) {
        console.error('請求失敗:', error);
      }
    }
    
    ///20250609 1947
    async function translate_v1(text, source = 'auto', target = 'auto') {
      ///const text = document.getElementById('sourceText').value.trim();
      ///const targetLang = document.getElementById('langSelect').value;
      
      
      if (!text) {
        alert("請輸入要翻譯的文字！");
        return;
      }
      
      // 初始化，在 auto 判斷之前
      target = target.slice(0, 2);
      source = source.slice(0, 2);
      
      // 如果目標語言和來源語言相同，則自動選擇新的目標語言
      if (target === source) {
        target = (target === 'zh-TW') ? 'en-US' :  'zh-TW';
        ///return;
      }

      const encodedText = encodeURIComponent(text);
      const url = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${source}|${target}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const translating = data.responseData.translatedText;
        ///translated.innerText = `${translating}...${translated.textContent}`;
        ///translatedNew.innerText = `${translating}...`;
        return translating;
      } catch (err) {
        console.error(err);
        ///translated.innerText = "[ALARM]..." + translated.textContent;
        ///translatedNew.innerText = "[ALARM]...";
        return null;  // "***"
      }
    }
    
    // 監聽視窗大小***
    function updateStructSize() {
        ///console.log("視窗高度：" + window.innerHeight + " px");
        ///console.log("視窗寬度：" + window.innerWidth + " px");
        //////document.getElementById('chatbox').style.height = (window.innerHeight * 0.7) + 'px'; // 佔 70%
        ///document.getElementById('InputRoom').style.height = (window.innerHeight * 0.05) + 'px'; // 佔 10%
        ///document.getElementById('InputMsg').style.height = (window.innerHeight * 0.05) + 'px'; // 佔 10%
        
        ///document.getElementById('copyright').style.height = (window.innerHeight * 0.05) + 'px'; // 佔 10%
        ///document.getElementById('detail').style.height = (window.innerHeight * 0.10) + 'px'; // 佔 10%
        
        const buttons = document.querySelectorAll('button');

        buttons.forEach(btn => {
          //btn.style.margin = '0';
          //btn.style.padding = '0';
          ///btn.style.border = 'none';
        });
        
        ///document.getElementById('ButtonRoom').style.width = (window.innerWidth * 1.0) + 'px'; // 佔 10%
        ///document.getElementById('ButtonMsg').style.width = (window.innerWidth * 1.0) + 'px'; // 佔 10%
        ///document.getElementById("Container").style.padding = (window.innerWidth / 66) + "px";  //QR
        ///document.getElementById("NINS").style.padding = (window.innerWidth / 66) + "px";  //QR
        ///document.getElementById("NINS").style.width = (window.innerHeight / 2) + "px";  //QR
    }
    ///window.addEventListener('resize', () => {});
    window.addEventListener("resize", updateStructSize);  // 視窗持續監聽
    window.addEventListener("keydown", updateStructSize);  // 按鈕持續監聽
    window.addEventListener("scroll", updateStructSize);  // 滾動持續監聽
    ///window.onload = function() {};
    window.onload = updateStructSize;
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        console.log("同步初始化，視窗高度：" + window.innerHeight + " px");
        console.log("同步初始化，視窗寬度：" + window.innerWidth + " px");
        document.getElementById('chatbox').textContent = "After using the 'Send Connection' button and successfully establishing the connection, you can use 'Send Message' to communicate.";    
    });
    
    // 初始化
    document.addEventListener('DOMContentLoaded', async function () {
        console.log("非同步初始化，視窗高度：" + window.innerHeight + " px");
        console.log("非同步初始化，視窗寬度：" + window.innerWidth + " px");
        document.getElementById('chatbox').textContent = "After using the 'Send Connection' button and successfully establishing the connection, you can use 'Send Message' to communicate.";    
    });
    
    // 初始化：默認掃描連線
    
    ///20250616 1415
    document.addEventListener('DOMContentLoaded', async function () {
      const language = navigator.language || navigator.userLanguage || "en-US";
      const source = "en";
      const target = language;
      let message = ""
      document.getElementById('InputRoom').placeholder = "(👁️" + language + ", 📶Use the same number to connect." + ")";  // as other devices to connect
      document.getElementById('InputMsg').placeholder = "(👁️" + language + ", 🚀Use your native language to chat." + ")";  //👁️👀👄
      
    });
    
    </script>
    
  <script>
    // 連線前的禁用****
    document.getElementById('Selectslang').disabled = true;  // 禁用
    ///document.getElementById('Selectslang').style.display = 'none';
    document.getElementById('Selectilang').disabled = true;  // 禁用
    ///document.getElementById('Selectilang').style.display = 'none';
    document.getElementById('Selecttlang').disabled = true;  // 禁用
    ///document.getElementById('Selecttlang').style.display = 'none';
    
    document.getElementById('InputMsg').disabled = true;  // 禁用
    document.getElementById('InputMsg').style.display = 'none';
    document.getElementById('ButtonMsg').disabled = true;  // 禁用
    document.getElementById('ButtonMsg').style.display = 'none';
    document.getElementById('ButtonMike').disabled = true;  // 禁用
    document.getElementById('ButtonMike').style.display = 'none';
    ///document.getElementById('BurronLink').disabled = true;  // 禁用
    ///document.getElementById('BurronLink').style.display = 'none';
    document.getElementById('chatbox').disabled = true;  // 禁用
    document.getElementById('chatbox').style.backgroundColor = '#cdcdcd';  ///#777777
    
    ///document.getElementById('ButtonRoom').disabled = true;  // 禁用
    document.getElementById('ButtonRoom').style.display = 'none';  // 不禁用，但隱藏
    const EmojisUser = [
      "🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯",
      "🦁", "🐮", "🐷", "🐸", "🐵", "🐔", "🐧", "🐦", "🐤", "🐣",
      "🐥", "🦆", "🦉", "🦇", "🐺", "🐗", "🐴", "🦄", "🐝", "🐛",
      "🐌", "🦋", "🐞", "🕷", "🦂", "🐢", "🐍", "🦖", "🐙", "🐠",
      "🐟", "🦈", "🐬", "🐳", "🐋", "🐌", "🦐", "🍏", "🍎", "🍊",  //5
      "🍋", "🍌", "🍉", "🍇", "🍓", "🍒", "🍍", "🥥", "🥝", "🍅",
      "🥑", "🍆", "🥦", "🥬", "🥒", "🌶", "🥕", "🥔", "🍠", "🌽",
      "🥐", "🍞", "🥖", "🥨", "🥯", "🧀", "🍳", "🥚", "🍔", "🍟",
      "🍕", "🌭", "🍿", "🥗", "🍎", "🥨", "🍜", "🍣", "🍱", "🍛",
      "🍙", "🍚", "🍘", "🍥", "🍡", "🍢", "🍿", "🍮", "🍭", "🍩",  //10
      "🍪", "🎂", "🍰", "🍦", "🍧", "🍨", "🧁", "🍫", "🍬", "🍭",
      "☕", "🍵", "🍶", "🍷", "🍸", "🍹", "🧃", "🥤", "🧊"
    ];
    const EmojisClock = [
      "🕛", // 00
      "🕐", // 01
      "🕑", // 02
      "🕒", // 03
      "🕓", // 04
      "🕔", // 05
      "🕕", // 06
      "🕖", // 07
      "🕗", // 08
      "🕘", // 09
      "🕙", // 10
      "🕚", // 11
      "🕛", // 12
      "🕐", // 13
      "🕑", // 14
      "🕒", // 15
      "🕓", // 16
      "🕔", // 17
      "🕕", // 18
      "🕖", // 19
      "🕗", // 20
      "🕘", // 21
      "🕙", // 22
      "🕚"  // 23
    ];
    
    
    document.getElementById("InputRoom").value = params.get("channel") || "";  // 取得 ?room= 後面的值  //BETA***
    document.getElementById("InputMsg").value = params.get("message") || "";  // 取得 ?room= 後面的值  //Hello.
    ///document.getElementById("ButtonRoom").focus();
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    
    
    /*
    if (ably) {
        ably.close(); // Close existing connection if it exists
        ably = null;
    }
    if (!ably) {  ///!!!
        if (apikey_user) { ably = new Ably.Realtime({ key: apikey_user, clientId: uuid_user }); }
        else { 
            ably = new Ably.Realtime({ key: apikey_nins, clientId: uuid_user });
            ///ably = new Ably.Realtime({ authUrl: 'https://duguaynins-apininsown.hf.space/auth', authMethod: 'GET', authHeaders: { 'Authorization': `Bearer ${token_nins}` } });
        }
    }*/
    
    ///if (document.getElementById("InputRoom").value) {sendSocket();}  // 暫時關閉自動連線，這導致沒有初始化完成對話框
    ///if (document.getElementById("InputRoom").value) {sendMessage();}
    ///if (document.getElementById("InputMsg").value) {sendMessage();}
    
    // 檢查使用的裝置，是行動裝置時，回傳 TRUE
    function isMobileDevice() {  ///TEST
      return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    }
    
    
    // 連線閒置檢查****
    let lastSentTime = Date.now();
    function userIdleChecker(idleMinutes = params.get("idle") || 2) {    // 每幾分鐘檢查是否閒置
    ///function userIdleChecker(idleMinutes = 2) {    // 每幾分鐘檢查是否閒置
        if (idleMinutes == "nins") console.log('NINS!!!MAX!!!');
        if (idleMinutes == "nins") return;
        
        lastSentTime = lastSentTime;
        idleMinutes = parseFloat(idleMinutes);
        console.log('idleSet: ', idleMinutes);
        ///if (idleMinutes == "NaN") idleMinutes = 0.5;
        if (isNaN(idleMinutes)) idleMinutes = 2.0;         // ✅ 正確判斷 NaN
        if (idleMinutes < 0.1) idleMinutes = 2.0;
        if (idleMinutes > 5.0) idleMinutes = 2.0;
        ///idleMinutes = 60;  // 閒置狀態以已小時為限？？？
        console.log('idleSet: ', idleMinutes);
        
        setInterval(() => {
          const now = Date.now();
          const idleTime = now - lastSentTime;
    
          if (ably) { // 連線存在
            ///console.log('nowTime: ', now);
            ///console.log('lastTime: ', lastSentTime);
            
            if (idleTime > idleMinutes * 60 * 1000) {  // 特定時間內未發訊息
            
                if (!apikey_user && ably.connection.state!="closed") {
                  console.log('⚠️ 閒置超時。');
                  
                  // 取得時間**
                  const nowUTC = new Date().toISOString();
                  const hourUTC = new Date(nowUTC).getUTCHours();  // 取得 UTC 小時（0-23）
                  const emoji_clock = EmojisClock[hourUTC];
                  
                  // 段開顯示**
                  ably.close(); // Close existing connection if it exists
                  const p = document.createElement('p');
                  p.innerHTML = `${emoji_clock}${nowUTC}（⛔${uuid_user || 'USER'}）`;p.style.color = 'red';  ///🔴
                  p.setAttribute('translate', 'no');  //???
                  document.getElementById("chatbox").prepend(p);
                  
                  // 阻隔使用**
                  ///document.getElementById("disabled").disabled = true;
                  ///document.getElementById("disabled").style.display = '';
                  
                  document.getElementById("InputMsg").disabled = true;
                  document.getElementById("ButtonMsg").disabled = true;
                  document.getElementById("chatbox").style.backgroundColor = '#cdcdcd';
                  ///document.getElementById("InputMsg").style.backgroundColor = '#cdcdcd';
                } 
                
            } else { console.log('idle...?'); }
          } else { console.log('connect...?'); }
          
        }, 60000/60); // 檢查於每分鐘之幾
    };userIdleChecker();
    
    
    // 接收****
    // 立即註冊訂閱監聽
    async function sendMessage() {
        lastSentTime = Date.now();
        
        let message = null;
        let source = null;
        let target = null;
        
        // 確保內容***
        const input = document.getElementById('InputMsg');
        const msg = input.value;
        if (!msg) { document.getElementById('InputMsg').focus();return; }  // 判斷內容存在與否
        
        // 正規化去除使用者輸入的表情***
        const emojiRegex = /([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDD00-\uDDFF])/g;
        // 比對法
        ///const hasEmoji = emojiRegex.test(msg);
        ///const emojis = msg.match(emojiRegex);
        // 清除法
        message = "I sent a test message.";
        message = "...";
        source = 'en';
        target = tlang;
        const smsg = msg.replace( emojiRegex, '' )
        if (!smsg) return;  //???
        ///await translate(message, source, target);  // 進行翻譯**
        
        // 測試先行刪除***
        input.value = '';
        
        
        
        
        
        // 測試IFRAME***
        
          // 1. 定義 IFRAME 內部要顯示的完整 HTML 內容
          
          // 2. 獲取要插入 IFRAME 的容器
      
          // 3. 創建一個 IFRAME 元素
      
          // 4. 將定義好的 HTML 內容賦值給 IFRAME 的 srcdoc 屬性 
          
          // 5. 清空 <details> 除了 <summary> 的內容 
          
          // 6. 插入 iframe（在 summary 後）
          
        // 測試IFRAME***
        
        
        // 聊天的時間記錄***
        
        ///window.open("https://translate.google.com/?sl=auto&tl=en&op=translate&text=" + smsg, "_blank");alert();
        ///document.getElementById('LinkTrans').href = "https://translate.google.com/?sl=auto&tl=en&op=translate&text=" + smsg;
        ///const imsg = prompt("（en: ***）");
        
        const imsg = await translate({ "text": smsg, "source": slang, "target": ilang });  // 進行翻譯**  //???
        if (!imsg) return;
        const rmsg = await translate({ "text": smsg, "source": slang, "target": rlang });  // 進行翻譯**  //???
        if (!rmsg) return;
        
        ///const randomID = "id_" + Math.random().toString(36).substring(2, 8);  // 產生短隨機 ID
        
        const nowUTC = new Date().toISOString();
        console.log(nowUTC);  // 例如：2025-06-14T09:22:30.123Z
        const hourUTC = new Date(nowUTC).getUTCHours();  // 取得 UTC 小時（0-23）
        
        const emoji_clock = EmojisClock[hourUTC];
        const emoji_texti = '🔄';  //🔣🤖
        const emoji_texts = '🔣';  //🔣🤖
        const emoji_lang = '👄';  //👄👂
        const result = (emoji_clock + nowUTC) + ("🔄" + rmsg) + ("🤖" + imsg) + ("🔣" + smsg) + ("👄" + ilang + "|" + slang);/// + ("🆔" + randomID);  //???
        // 發送訊息
        channel.publish('message', result);
        input.value = '';
        
        // 語意距離
        const distance = await semantic({ "smsg": smsg, "rmsg": rmsg }); // duguaynins/SemanticDistance
        ///channel.publish('message', result);
        //////alert(distance);
        
        input.placeholder = "（" + "👄" + slang + ", " + "🎯" + distance + "）";
        input.setAttribute("translate", "no");
    }
    
    
    
    
    
    // 連線後的禁用****
    // 收到訊息時更新聊天室  
    function sendSocket() {      
        lastSentTime = Date.now();
    
        // 取消以下兩行
        ///document.getElementById('InputRoom').value = document.getElementById('InputRoom').value || "WORLD";
        ///document.getElementById('InputRoom').value = "WORLD";  // 暫時所有人都必須使用此  ///!!!
        
        document.getElementById('InputRoom').dispatchEvent(new Event('input')); // 手動觸發事件
        ///document.getElementById('barcodeSlider').value = 222;
        ///document.getElementById('barcodeSlider').dispatchEvent(new Event('input')); // 手動觸發事件
      
        ///const room = ("WORLD");  // ALL, BETA  ///!!!
        const buf_room = document.getElementById('InputRoom').value.split('&&')[0];  console.log(buf_room);
        const buf_apikey = document.getElementById('InputRoom').value.split('&&')[1];console.log(buf_apikey);
        let room = document.getElementById('InputRoom').value.split('&&')[0] || ("WORLD");  // ALL, BETA  ///!!!
        let apikey = document.getElementById('InputRoom').value.split('&&')[1] || ("ijFBLQ.6d_0Tg:5ueQrEJ1sjpW1MN9kDlLOzyPoYyYAzufOmGYxMLEV2s");  // ALL, BETA  ///!!!
        let token = params.get("token");
        
        document.getElementById('InputRoom').value = ("WORLD");  ///!!!
        ///!!!
        
        document.getElementById('Selectslang').disabled = false;  // 啟用
        ///document.getElementById('Selectslang').style.display = '';
        document.getElementById('Selectilang').disabled = false;  // 啟用
        ///document.getElementById('Selectilang').style.display = '';
        document.getElementById('Selecttlang').disabled = false;  // 啟用
        ///document.getElementById('Selecttlang').style.display = '';
        
        document.getElementById('chatbox').textContent = "";
        
        
        
        if (ably) {
            ably.close(); // Close existing connection if it exists
            ably = null;
        }
        if (!ably) {  ///!!!
            ///if (apikey_user) { ably = new Ably.Realtime({ key: apikey_user, clientId: uuid_user });console.log("apikey_user"); }
            ///if (!apikey_user) { ably = new Ably.Realtime({ key: apikey_nins, clientId: uuid_user });console.log("!apikey_user"); }
            
            
            if (token) {
            
                ably = new Ably.Realtime({ authUrl: 'https://duguaynins-apininsown.hf.space/auth', authMethod: 'POST', authHeaders: { 'clientId': uuid_user, 'Beta': `TOEKN ${token}`, 'Authorization': `Bearer ${token_nins}` } });
                /*
                ably = new Ably.Realtime({
                    authCallback: function(tokenParams, callback) {
                        ///fetch('http://localhost:7860/auth', {
                        fetch('https://duguaynins-apininsown.hf.space/auth', {
                            method: 'POST',
                            headers: {
                                'clientId': uuid_user,
                                'Content-Type': 'application/json',
                                'Beta': `TOKEN ${token}`,
                                'Authorization': `Bearer ${token_nins}`
                            },
                            body: JSON.stringify({
                                clientId: uuid_user
                            })
                        })
                        .then(response => response.json())
                        .then(tokenRequest => callback(null, tokenRequest))
                        .catch(error => callback(error, null));
                    }
                });*/
                ///ably = new Ably.Realtime({ authUrl: 'https://duguaynins-apininsown.hf.space/auth', authMethod: 'GET', authHeaders: { 'Beta': `TOEKN ${token}`, 'Authorization': `Bearer ${token_nins}` } });    
            }
            else if (apikey) {
                ably = new Ably.Realtime({ key: apikey, clientId: uuid_user });console.log("apikey_user");
                
                if (apikey === "ijFBLQ.6d_0Tg:5ueQrEJ1sjpW1MN9kDlLOzyPoYyYAzufOmGYxMLEV2s") {
                    apikey_user = "";
                    room = "WORLD";  // 使用我的金鑰必須固定頻道
                    ///room = room;  // 廣為人知後開放自訂房間
                    // 只登入自有的令牌
                    updateQR();
                }
                else {
                    apikey_user = apikey;
                    room = room;
                    // 儲存令牌
                    ///fetch('http://localhost:7860/auth', {
                    fetch('https://duguaynins-apininsown.hf.space/auth', {
                      method: 'POST',
                      headers: {
                        'clientId': uuid_user,
                        'Content-Type': 'application/json',
                        'Beta': `APIKEY ${apikey}`,
                        'Authorization': `Bearer ${token_nins}`  // 或 'TOEKN your_token'
                      },
                      body: JSON.stringify({ /* 如果需要送其他資料，可放這裡 */ })
                    })
                    .then(response => response.json())
                    .then(data => {
                      console.log('後端回應:', data);
                      
                      updateQR(data.token);
                    })
                    .catch(error => {
                      console.error('錯誤:', error);
                    });
                }
            }
            
            
            
            
        }
        
        // 判斷連線結果
        if (ably) {
        ably.connection.on((stateChange) => {
        
          const state = document.getElementById('stateConnection');
          
          console.log('Connection changed from', stateChange.previous, 'to', stateChange.current);
        
          switch (stateChange.current) {
            case 'initialized':
              console.log('📘 Initialized: SDK instance created, not yet connecting.');
              state.textContent  = "📘（Initialized）";
              break;
            case 'connecting':
              console.log('🔣 Connecting: Attempting to establish a connection.');
              state.textContent  = "🔣（Connecting）";
              break;
            case 'connected':
              console.log('✅ Connected: Successfully connected to Ably.');
              state.textContent  = "✅（Connected）";
              break;
            case 'disconnected':
              console.log('⚠️ Disconnected: Connection is temporarily unavailable, retrying...');
              state.textContent  = "⚠️（Disconnected）";

              /*
              ably.close();  ///!!!
              document.getElementById("InputMsg").disabled = true;
              document.getElementById("ButtonMsg").disabled = true;
              document.getElementById("chatbox").style.backgroundColor = '#cdcdcd';
              ///document.getElementById("InputMsg").style.backgroundColor = '#cdcdcd';*/

              break;
            case 'suspended':
              console.log('⛔ Suspended: Connection failed for too long. Will retry after a delay.');
              state.textContent  = "⛔（Suspended）";
              break;
            case 'closing':
              console.log('📴 Closing: Connection is being closed.');
              state.textContent  = "📴（Closing）";
              break;
            case 'closed':
              console.log('🔒 Closed: Connection has been closed.');
              state.textContent  = "🔒（Closed）";
              break;
            case 'failed':
              console.log('❌ Failed: Connection failed permanently. Manual intervention required.');
              state.textContent  = "❌（Failed）";
              if (stateChange.reason) {
                console.error('Reason:', stateChange.reason.message);
                state.textContent  = "❌（Failed＝" + stateChange.reason.message + "）";
              }
              break;
            default:
              console.log('Unknown connection state:', stateChange.current);
          }
        });
        }
        
        // 特殊聲明******
        const p = document.createElement("p");
        p.style.color = "red"; // 可以用 CSS 顏色名稱或 HEX
        p.innerHTML  = `
              <p translate="no">⚠️© 2024 NINS. 👻</p>
              <p>⚠️For your safety, only open files and links you sent yourself. ***</p>
              <p>⚠️Here, we are all representatives of humanity! ***</p>
              <p>⚠️To share and communicate as all humans rightly do. ***</p>
              <p>⚠️This service does not retain any records due to security reasons.</p>
              <p>⚠️This service provides limited translation capabilities due to being free of charge.</p>
              <p>⚠️For the best experience, please use Google Chrome!</p>
              <p>⚠️...</p>
              <p>⚠️By using any of the services, it means you have agreed to any content and all content! ***</p>
              <p translate="no">⚠️© 2024 NINS. 👻</p>
              `
        document.getElementById("chatbox").prepend(p);
          
        document.getElementById('InputRoom').disabled = true;  // 禁用
        document.getElementById('InputRoom').style.display = 'none';
        document.getElementById('ButtonRoom').disabled = true;  // 禁用
        document.getElementById('ButtonRoom').style.display = 'none';
        document.getElementById('InputMsg').disabled = false;  // 啟用
        document.getElementById('InputMsg').style.display = '';
        document.getElementById('ButtonMsg').disabled = false;  // 啟用
        document.getElementById('ButtonMsg').style.display = '';
        
        document.getElementById('ButtonMike').disabled = false;  // 啟用
        document.getElementById('ButtonMike').style.display = '';
        ///document.getElementById('BurronLink').disabled = false;  // 啟用
        ///document.getElementById('BurronLink').style.display = '';
        document.getElementById('chatbox').disabled = false;  // 啟用
        document.getElementById('chatbox').style.backgroundColor = '#ffffff';  //#cdcdcd
        
        ///document.getElementById('ButtonMsg').disabled = true;  // 禁用
        document.getElementById('ButtonMsg').style.display = 'none';  // 不禁用，但隱藏
        
        const input = document.getElementById('InputRoom');
        const button = document.getElementById('ButtonRoom');
        ///const room = input.value;  // ALL, BETA  ///!!!
        channel = ably.channels.get(room);  // 根據房間連線
        input.value = room;
              
        // 正式進入頻道**
        channel.presence.enter();
        // 監聽**
        ///channel.attach(() => {
        ///channel.presence.get((err, members) => {
        channel.presence.subscribe('enter', (member) => {
            // 取得時間**
            const nowUTC = new Date().toISOString();
            const hourUTC = new Date(nowUTC).getUTCHours();  // 取得 UTC 小時（0-23）
            const emoji_clock = EmojisClock[hourUTC];
            
            // 紀錄事件**
            console.log(`${member.clientId} has entered.`);
            channel.presence.get((err, members) => {
              const p = document.createElement('p');
              p.innerHTML = `${emoji_clock}${nowUTC}（🟢${member.clientId || 'USER'}）`;p.style.color = 'green';
              p.setAttribute('translate', 'no');  //???
              document.getElementById("chatbox").prepend(p);
              if (!err) { console.log('Members:', members.length);document.getElementById("copyright").innerHTML = `👻（${room}, ${members.length}）`; }
            });
        });
          
        channel.presence.subscribe('leave', (member) => {
            // 取得時間**
            const nowUTC = new Date().toISOString();
            const hourUTC = new Date(nowUTC).getUTCHours();  // 取得 UTC 小時（0-23）
            const emoji_clock = EmojisClock[hourUTC];
            
            // 紀錄事件**
            console.log(`${member.clientId} has left.`);
            channel.presence.get((err, members) => {
              const p = document.createElement('p');
              p.innerHTML = `${emoji_clock}${nowUTC}（🔴${member.clientId || 'USER'}）`;p.style.color = 'red';
              p.setAttribute('translate', 'no');  //???
              document.getElementById("chatbox").prepend(p);
              if (!err) { console.log('Members:', members.length);document.getElementById("copyright").innerHTML = `👻（${room}, ${members.length}）`; }
            });
        });
        
        
        
        // 立即註冊訂閱監聽
        channel.subscribe('message', function(msg) {
          console.log("接收到的訊息:", msg);
          
          // 紀錄文字用的元素***
          const box = document.getElementById('chatbox');
          const p = document.createElement('p');
          ///p.textContent = msg.data;
          
          // 切割段落***
          ///const result = emoji_clock + nowUTC + emoji_texti + imsg + emoji_texts + smsg + emoji_lang + tlang;
          ///const result = (emoji_clock + nowUTC) + ("🔄" + imsg) + ("🔣" + smsg) + ("👄" + ilang + "|" + slang);  //???
          ///const result = (emoji_clock + nowUTC) + ("🔄" + rmsg) + ("🤖" + imsg) + ("🔣" + smsg) + ("👄" + ilang + "|" + slang);  //???
          let index = null;  // 根據索引**
          let before = null;
          let after = null;
          // 初始化**
          after = null;
          before = msg.data;
          // 取得語言**
          index = before.lastIndexOf("👄");
          after = before.substring(index + "👄".length);
          before = before.substring(0, index);
          index = after.lastIndexOf("|");
          const msgtLangs = after.substring(index + "|".length);
          const msgtLangm = after.substring(0, index);
          const msgtLangr = "en";
          console.log("👄sl:", msgtLangs);
          console.log("👄il:", msgtLangm);
          console.log("👄rl:", msgtLangr);
          // 取得原文語言**
          index = before.lastIndexOf("🔣");
          after = before.substring(index + "🔣".length);
          before = before.substring(0, index);
          const msgtTexts = after;
          console.log("🔣", msgtTexts);
          // 取得中間語言**
          index = before.lastIndexOf("🤖");
          after = before.substring(index + "🤖".length);
          before = before.substring(0, index);
          const msgtTextm = after;
          console.log("🤖", msgtTextm);
          // 取得顯示語言**
          index = before.lastIndexOf("🔄");
          after = before.substring(index + "🔄".length);
          before = before.substring(0, index);
          const msgtTextr = after;
          console.log("🔄", msgtTextr);
          // 取得時間**
          after = before.substring(0, before.length);  //"🕛".length
          before = before.substring(0 + "🕛".length);
          const msgTime = after;
          console.log("🕛", msgTime.slice("🕛".length));
          
          // 顯示結果***
          ///const result = (index !== -1) ? msg.data.substring(0, index) : msg.data;
          // 加入文字轉語音按鈕TTS**
          const randomID = "id_" + Math.random().toString(36).substring(2, 8);  // 產生短隨機 ID
          const functionName = `handleTTS_${randomID}`;  // 定義專屬函式名稱
          
          // 使用模板字串，插入 randomID 到 HTML 字串中**
          p.innerHTML = `
            
            <span id="${randomID}_T" style="color:black;" translate="no">${msgTime}</span>
            <span id="${randomID}_2" style="color:black;" translate="">（🔄${msgtTextr}）</span>
            <label  translate="no" style="color:black;">👂sl:${msgtLangs}<input style="display:none;" type="button" value="👂${msgtLangs}" onclick="handleTTS('${randomID}_0')" /></label>
            <label  translate="no" style="color:black;">👂il:${msgtLangm}<input style="display:none;" type="button" value="👂${msgtLangm}" onclick="handleTTS('${randomID}_1')" /></label>
            <label  translate="no" style="color:black;">👂rl:${msgtLangr}<input style="display:none;" type="button" value="👂${msgtLangr}" onclick="handleTTS('${randomID}_9')" /></label>
            <!--p id="${randomID}_S" translate="no" >（🎯???）</p--><br>
            <p id="${randomID}_0" translate="no" style="display:none; color:gray;">（🔣${msgtTexts}👄${msgtLangs}）</p>
            <p id="${randomID}_1" translate="no" style="display:none; color:gray;">（🤖${msgtTextm}👄${msgtLangm}）</p>
            <p id="${randomID}_9" translate="no" style="display:none; color:gray;">（👻${msgtTextr}👄${msgtLangr}）</p>
            
            <!--span id="${randomID}_2" translate="">（🔄${msgtTextm}）</span><br-->
          `;
          
          //document.getElementById("chatbox").appendChild(p);  // 取消CCS時，改用此。
          document.getElementById("chatbox").prepend(p); // 加在最上層，但因為 column-reverse 是「視覺底部」。
          box.scrollTop = box.scrollHeight;
        });
        
        
        // 第一次加入聊天室時***  // 已經顯示加入訊息，所以不需要這個了
        ///document.getElementById("InputMsg").value = "I joined the " + room + " channel.";
        ///document.getElementById("ButtonMsg").click();
        document.getElementById("InputMsg").focus();
    }
    
    

    
    // 處理文字轉語音****
    // 的按鈕點擊事件****
    function handleTTS(id, lang = "") {
        document.getElementById(id).style.display = "";
        
        // 移除再加上 class，確保每次點擊都能觸發動畫
        document.getElementById(id).classList.remove('breathe');
        void document.getElementById(id).offsetWidth; // 強制 reflow
        document.getElementById(id).classList.add('breathe');
    
        if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) {
            alert("No TTS.")
            ///alert("此瀏覽器不支援語音合成功能（TTS）。請改用 Chrome 或 Safari。");
            return;
        }
        if (!voices || voices.length === 0) {
            alert("No TTS voices.")
            ///alert("語音清單尚未載入，請稍後再試。");
            return;
        }
        console.log("Voices loaded:", voices.length);
        
        // 製作文字轉語音***
        // 找到文本**
        const input = document.getElementById("InputRate");
        const element = document.getElementById(id);
        const text = element.textContent;
        //if (element) { alert("副文字內容為： " + element.textContent); }
        // 取得語言**
        const index = text.lastIndexOf("👄");
        const before = text.substring(0, index);        // 👄 前的內容
        const after = text.substring(index + "👄".length); // 👄 後的內容（+1）
        // 格式化**
        const content = before.substring(1 + "🔣".length);
        const language = after.substring(0, after.length - 1)   // 或 after = after.slice(0, -1);
        const talkrate = input.value;
        console.log("content:", content);
        console.log("language:", language);
        console.log("talkrate:", talkrate);
      
        // 取得聲音
        ///const lang = tlang.slice(0, 2);
        const msg = new window.SpeechSynthesisUtterance();  // "你好，歡迎使用語音系統
        // 不設定 msg.lang，結果不一定正確（可能變英文腔）
        msg.text = content;
        msg.lang = language;           // 語言代碼
        msg.rate = talkrate;           // 語速 0.1 ~ 10
        msg.volume = 1;                // 音量 0~1
        msg.pitch = 1;                 // 音高 0~2
        //msg.voice = voices[i];        // 可選擇語音
        //msg.voice = window.speechSynthesis.getVoices()[0];
        //msg.voice = voices.find(v => v.lang === language) || voices.find(v => v.lang.startsWith(language.slice(0, 2)));  
        // voice 導致第一次非默認會失敗，因此註解。
        
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();    // ✅ 清除先前語音，避免阻塞**
            window.speechSynthesis.speak(msg);  // ✅ 播放語音
        } else if (!speechSynthesis.speaking) {
            window.speechSynthesis.speak(msg);  // ✅ 播放語音
        }
    }
    
    
    
  </script>
  
    <script>
    // 語音轉文字
    let autoRestart = null;
    let recognition = null;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) { recognition = new SpeechRecognition(); }
    
    if (!recognition) { 
        const button = document.getElementById("ButtonMike");
        button.textContent = "🎙️（Browser not supported）";
        button.disabled = true;
        ///return; 
    }
    if (recognition) {
    
        let finalTranscript = '';  // 最終結果
        let interimTranscript = '';  // 中間結果
        
        let isRecognizing = null;
        const button = document.getElementById("ButtonMike");
        ///const recognition = new SpeechRecognition();        
        
        // 監聽點擊
        document.getElementById("ButtonMike").addEventListener("click", () => {
          if (button.textContent === "🎙️") { button.textContent = "🎙️（STOP）"; }
          if (button.textContent === "🎙️（STOP）") {
            
            
            // 選擇中間顯示，根據設備
            if (isMobileDevice()) {
                ///console.log("目前為行動裝置，不支援語音轉文字的中間結果。");
                ///alert("目前為行動裝置，不支援語音轉文字的中間結果。");  ///✅ 🛑
                recognition.interimResults = false; ///TEST
                recognition.continuous = true; ///TEST  ///BETA***
            }
            else {
                recognition.interimResults = true;  //OK
                recognition.continuous = true;  //OK
            }
            
            // 選擇語言
            if (!recognition.lang) {  // 口語語言設定偵測  // 必須 start() 之前
                ///recognition.lang = prompt("Input your speek language: (zh-TW || ja-JP || ko-KR || en-US)***") || tlang;
                recognition.lang = tlang;  //tlang, slang  // 要講其他語言就自己更換瀏覽器語言吧！！！  //???
            }
            
            button.textContent = "🎙️（KEEP＝" + recognition.lang + "）";
            recognition.start();
            autoRestart = true;
            
          } else {
            button.textContent = "🎙️（STOP）";
            recognition.stop();
            autoRestart = false;
          }
        });
        
        // 轉錄開始***
        recognition.onstart = () => {
          console.log('辨識開始：', "~~~");
          button.textContent = "🎙️（KEEP＝" + recognition.lang + "）";
          if (autoRestart) {
              if (isMobileDevice()) { /*recognition.stop();recognition.start();*/ }  //OK
              else                  { /*recognition.stop();recognition.start();*/ }  //OK
          }
        };
        
        // 轉錄結束***
        recognition.onend = () => {
          console.log('辨識停止：', "~~~");
          button.textContent = "🎙️（STOP）";
          if (autoRestart) {
              if (isMobileDevice()) { recognition.stop();recognition.start(); }  //OK
              else                  { recognition.stop();recognition.start(); }  //OK
          }
        };
        
        // 轉錄錯誤***
        recognition.onerror = (event) => {
          console.error('辨識錯誤：', event.error);
          ///alert(event.error);
          
          if (event.error === "no-speech") {
            console.log("重新啟動辨識中...");
            autoRestart = true; 
            
            // 雖然似乎會自動重新啟動
            ///recognition.stop();recognition.start();  // stop(); 或 abort();  // 自動重啟，只要不是使用者手動按「停止」
            
            button.textContent = "🎙️（KEEP＝" + recognition.lang + "）";  //???
            ///!!!
          } else { 
            console.log("停止錯誤辨識中...");
            autoRestart = false; 
            
            // 不重啟錄音
            
            button.textContent = "🎙️（ERROR＝" + event.error + "）";
            ///setTimeout(() => button.textContent = "🎙️（ERROR＝" + event.error + "）", 1000);  // 方便閱讀
            ///setTimeout(() => null, 1000);  // 方便閱讀
            ///setTimeout(() => recognition.abort(), 1000); // 自動關閉
            
          }  // "network", "no-allowed"
        };
        
        
        
        // 轉錄結果***
        recognition.onresult = (event) => {
          interimTranscript = '';
          finalTranscript = '';  // 需要定期清除時，開啟！
          
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              const result = (interimTranscript || transcript) + '...';  // 手機不支援中間結果
              finalTranscript = result + finalTranscript;
              // 可以讓雙端顯示！
              if (isMobileDevice()) { document.getElementById("InputMsg").value = finalTranscript.trim(); }
              else                  { document.getElementById("InputMsg").value = finalTranscript.trim(); }
              
              ///translate(result, recognition.lang, tlang);  // 翻譯
              ///sendMessage();
              ///document.getElementById("InputMsg").focus();
              ///document.getElementById("InputMsg").value += " ";
              ///document.getElementById("ButtonMsg").click();
              // 如何讓雙端傳送？
              if (isMobileDevice()) { sendMessage(); /*document.getElementById("ButtonMsg").click();*/ /*document.getElementById("InputMsg").focus();*/ }
              else                  { sendMessage(); /*document.getElementById("ButtonMsg").click();*/ }  // 講者可以按鈕傳送
              
            } else {
              const result = (transcript) + '...\n';
              interimTranscript += transcript;  // 或 interimTranscript + transcript + '\n';  // 將中間結果()
              
              ///translate(interimTranscript.trim(), 'auto', 'auto');  // 翻譯
              // 如何讓手機顯示？
              if (isMobileDevice()) { document.getElementById("InputMsg").value = interimTranscript.trim(); }
              else                  { document.getElementById("InputMsg").value = interimTranscript.trim(); }
            }
          }
          ///document.getElementById("InputMsg").value = finalTranscript.trim();  // 分別插入中間與結果
          ///document.getElementById("ButtonMsg").click();  // 分別插入中間與結果
        };
    }
    </script>
    
  
    <script>
    ///20250622
    // 決定追加的語言
    ///window.onload = function() {
    document.addEventListener('DOMContentLoaded', () => {
        const news = document.createElement("option");        
        news.value = tlang;///this.options[this.selectedIndex].value;///this.value;
        news.text = "auto*";///this.options[this.selectedIndex].text;///this.text;
        document.getElementById("Selectslang").appendChild(news);
        news.selected = true;  // ✅ 設為預設選中
        
        const newi = document.createElement("option");
        newi.value = tlang;///this.options[this.selectedIndex].value;///this.value;
        newi.text = "auto*";///this.options[this.selectedIndex].text;///this.text;
        document.getElementById("Selectilang").appendChild(newi);
        newi.selected = true;  // ✅ 設為預設選中
    });  // 載入監聽
    ///};
    
    document.getElementById("Selectslang").addEventListener("change", function () {
        if (true) { 
            const selectedValue = this.value;
            slang = selectedValue;  // 輸入的語言
            console.log("選擇了：", selectedValue);
            autoRestart = false;  ///!!!
        }

        if (!recognition) { }
        if (recognition) {  ///!!!
            
            recognition.lang = slang;
            ///recognition.stop();recognition.start();

            recognition.stop();  ///!!!
            document.getElementById("ButtonMike").textContent = "🎙️（STOP）";  ///!!!
        }
    });
    
    document.getElementById("Selectilang").addEventListener("change", function () {
        const selectedValue = this.value;
        ilang = selectedValue;  // 學習的語言
        console.log("選擇了：", selectedValue);
        
        ///const news = document.createElement("option");
        ///news.value = this.options[this.selectedIndex].value;///this.value;
        ///news.text = this.options[this.selectedIndex].text;///this.text;
        ///document.getElementById("Selectslang").appendChild(news);
        // 這裡可以加入其他邏輯，例如根據選擇更改語言、顯示訊息等
    });
    
    // 鬼鬼速度！！！
    document.getElementById('InputSpeed').addEventListener('input', function () {
        speed = this.value;  // ✅ this 是 input 元素
    });
    </script>
    <script>
    ///20220623
    // 檔案下載
      function downloadChat() {
        ///const chatContent = document.getElementById("chatbox").innerText;  // display不被讀取***
        const chatContent = document.getElementById("chatbox").textContent;
        ///const blob = new Blob([chatContent], { type: "text/plain;charset=utf-8" });
        // OR 
        const BOM = "\uFEFF";  // 加入 UTF-8 BOM 解亂碼
        const blob = new Blob([BOM + chatContent], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        
        // 時間****
        const nowUTC = new Date().toISOString();
        const filetimestamp = nowUTC.replace(/[-:.]/g, '_');
        console.log(filetimestamp); // 例如：2025-07-02T06-56-31-400Z
        
        // 檔案名稱****
        const a = document.createElement("a");
        a.href = url;
        ///a.download = uuid_user + ".txt";
        a.download = "NINS_TRANSING_" + filetimestamp + ".txt";
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      function DUGUAYNINS() {
        window.open("https://jpgt.one/", "_blank", "noopener,noreferrer");
      }
      
    </script>
    
    <!--script src="copyright.js"></script-->
    <!--script>
    /*
      ///20240915-0000
      // 建立版權文字元素
      const copyright = document.createElement("div");
      copyright.textContent = "© 2024 NINS.";
      copyright.textContent = "👻";
      
      // 設定樣式
      Object.assign(copyright.style, {
        position: "fixed",
        top: "0px",
        left: "0px",
        padding: "5px 10px",
        backgroundColor: "rgba(0,0,0,0.5)",
        color: "#fff",
        /*fontSize: "14px",*/
        borderRadius: "4px",
        pointerEvents: "none",  // 不阻擋點擊
        userSelect: "none",     // 不可選取文字
        zIndex: "9999"
      });
    
      // 加入頁面
      document.body.appendChild(copyright);
    
      // 自動移動參數
      let x = 0, y = 0;
      let dx = 1, dy = 1;
      ///const speed = 1.2;
    
      function animate() {
        const maxX = window.innerWidth - copyright.offsetWidth;
        const maxY = window.innerHeight - copyright.offsetHeight;
    
        x += dx * speed;
        y += dy * speed;
    
        if (x <= 0 || x >= maxX) dx *= -1;
        if (y <= 0 || y >= maxY) dy *= -1;
    
        copyright.style.left = x + "px";
        copyright.style.top = y + "px";
    
        requestAnimationFrame(animate);
      }
    
      animate();
    */
    </script-->
    <script type="text/javascript">
      // GOOGLE TRANSLATE
      // 自動翻譯***
      ///document.cookie = "googtrans=/en/zh-TW; path=/";
      ///location.reload();
    
      function googleTranslateElementInit() {
        new google.translate.TranslateElement({
          pageLanguage: 'en',  ///'en', ilang, 改為根據中間語言  ///鼓勵輸入中間語言，翻譯必定可以顯示英文。
          includedLanguages: '',  ///zh-TW,ja,ko,en,hi,zh-CN
          autoDisplay: false,
          ///layout: google.translate.TranslateElement.InlineLayout.SIMPLE
        }, 'google_translate_element');
      }
      
    
      function autoTranslate(lang) {
        const tryTranslate = () => {
          const combo = document.querySelector('.goog-te-combo');
          if (combo) {
            const options = Array.from(combo.options).map(opt => opt.value);console.log('可用語言代碼:', options);
            combo.value = lang;
            combo.dispatchEvent(new Event('change'));
          } else {
            setTimeout(tryTranslate, 300); // 遞迴檢查
          }
        };
        tryTranslate();
      }
    
      window.addEventListener('load', () => {
        setTimeout(() => {
          ///const tlang = navigator.language || navigator.userLanguage || "en-US";
          autoTranslate(tlang);
          console.log("sl, tl：", tlang);
          
          ///document.getElementById(":1.container").style.display = "";
        }, 1000);
      });
    </script>
    
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <script>
    // 初始化：默認掃描連線
    function autoConnect() {
        ///channel = params.get("channel");
        document.getElementById('InputRoom').value = params.get("channel");
        if ( params.get("channel") ) { sendSocket(); }
        ///document.getElementById('chatbox').textContent = "";  // 此行放置於 sendSocket() 內部！
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => autoConnect(), 2500); // 自動連線  1000~3000
    });
    </script>
</body>
</html>
